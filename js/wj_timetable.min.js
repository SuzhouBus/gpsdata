'use strict';var _slicedToArray=function(){function sliceIterator(arr,i){var _arr=[];var _n=true;var _d=false;var _e=undefined;try{for(var _i=arr[Symbol.iterator](),_s;!(_n=(_s=_i.next()).done);_n=true){_arr.push(_s.value);if(i&&_arr.length===i)break}}catch(err){_d=true;_e=err}finally{try{if(!_n&&_i['return'])_i['return']()}finally{if(_d)throw _e}}return _arr}return function(arr,i){if(Array.isArray(arr)){return arr}else if(Symbol.iterator in Object(arr)){return sliceIterator(arr,i)}else{throw new TypeError('Invalid attempt to destructure non-iterable instance')}}}();function createElement(tagName,childOrChildren,attributes){var element=document.createElement(tagName);appendChildren(element,childOrChildren);var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=Object.entries(attributes||{})[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var _ref=_step.value;var _ref2=_slicedToArray(_ref,2);var name=_ref2[0];var value=_ref2[1];element.setAttribute(name,value)}}catch(err){_didIteratorError=true;_iteratorError=err}finally{try{if(!_iteratorNormalCompletion&&_iterator['return']){_iterator['return']()}}finally{if(_didIteratorError){throw _iteratorError}}}return element}function appendChildren(parent,childOrChildren){if(typeof childOrChildren=='string'){parent.appendChild(document.createTextNode(childOrChildren))}else if(childOrChildren instanceof Node){parent.appendChild(childOrChildren)}else if(childOrChildren&&childOrChildren.length){[].forEach.call(childOrChildren,function(child){return parent.appendChild(child)})}return parent}function removeChildren(parent){while(parent.hasChildNodes()){parent.removeChild(parent.childNodes[0])}}function replaceChildren(parent,childOrChildren){removeChildren(parent);appendChildren(parent,childOrChildren)}function fillSelect(select,labels,values){removeChildren(select);labels.forEach(function(label,index){var option=document.createElement('option');option.value=values?values[index]||label:label;option.appendChild(document.createTextNode(label));select.appendChild(option)})}
'use strict';var _slicedToArray=function(){function sliceIterator(arr,i){var _arr=[];var _n=true;var _d=false;var _e=undefined;try{for(var _i=arr[Symbol.iterator](),_s;!(_n=(_s=_i.next()).done);_n=true){_arr.push(_s.value);if(i&&_arr.length===i)break}}catch(err){_d=true;_e=err}finally{try{if(!_n&&_i['return'])_i['return']()}finally{if(_d)throw _e}}return _arr}return function(arr,i){if(Array.isArray(arr)){return arr}else if(Symbol.iterator in Object(arr)){return sliceIterator(arr,i)}else{throw new TypeError('Invalid attempt to destructure non-iterable instance')}}}();function _toConsumableArray(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++){arr2[i]=arr[i]}return arr2}else{return Array.from(arr)}}var lineSeparatorRegEx=/\r|\n|\r\n/;var PALETTE=[[230,25,75],[60,180,75],[255,225,25],[0,130,200],[245,130,48],[145,30,180],[70,240,240],[240,50,230],[210,245,60],[250,190,190],[0,128,128],[170,110,40],[128,0,0],[170,255,195],[128,128,0],[0,0,128]].map(function(x){return'rgb('+x.join(',')+')'});var allLines={};var allData={};var parsedLines={};var fetchPromise=fetch('wj_all.guid').then(function(x){return x.text()}).then(function(data){var lineChooser=document.getElementById('lineChooser');data.split(lineSeparatorRegEx).filter(function(x){return x}).map(function(x){return x.split(/\t/)}).forEach(function(line){var guid=line[0];var name=line[1];var direction=line[2];if(!allLines[name])allLines[name]=[];allLines[name].push({direction:direction,guid:guid})});fillSelect(lineChooser,Object.keys(allLines).sort())}).then(function(_){return fetch('wj_timetable.csv')}).then(function(x){return x.text()}).then(function(data){document.getElementById('progress').style.display='none';data.split(lineSeparatorRegEx).forEach(function(entry){var values=entry.split(',');var date=values[0];var licenseId=values[1];var time=values[2];var lineGuid=values[3];if(!allData[lineGuid])allData[lineGuid]={};if(!allData[lineGuid][date])allData[lineGuid][date]=[];allData[lineGuid][date].push({licenseId:licenseId,time:time})})});function defaultCompare(a,b){if(a>b)return 1;if(a<b)return-1;return 0}function parseByLineDate(line,date){var timetable={};var directions=allLines[line];directions.forEach(function(line,directionId){allData[line.guid][date].forEach(function(current){if(!timetable[current.licenseId])timetable[current.licenseId]=[];timetable[current.licenseId].push({directionId:directionId,time:current.time})})});var maxCols=0;var _loop=function _loop(licenseId,_runs){timetable[licenseId]=_runs=_runs.sort(function(a,b){return defaultCompare(a.time,b.time)});var currentDirection=0;var runsCount=0;_runs.forEach(function(details){if(currentDirection!=details.directionId)++runsCount;++runsCount;currentDirection=details.directionId==1?0:1});maxCols=Math.max(maxCols,runsCount);runs=_runs};var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=Object.entries(timetable)[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var _ref=_step.value;var _ref2=_slicedToArray(_ref,2);var licenseId=_ref2[0];var runs=_ref2[1];_loop(licenseId,runs)}}catch(err){_didIteratorError=true;_iteratorError=err}finally{try{if(!_iteratorNormalCompletion&&_iterator['return']){_iterator['return']()}}finally{if(_didIteratorError){throw _iteratorError}}}var order=Object.keys(timetable).sort(function(a,b){return defaultCompare(timetable[a][0].directionId,timetable[b][0].directionId)||defaultCompare(timetable[a][0].time,timetable[b][0].time)});return{maxCols:maxCols,data:new Map(order.map(function(k){return[k,timetable[k]]}))}}function parseLine(line){var dates=Array.from(allLines[line].reduce(function(result,cur){return Object.keys(allData[cur.guid]).forEach(function(date){return result.add(date)}),result},new Set)).sort();var parsedData=dates.map(function(date){return Object.assign({date:date},parseByLineDate(line,date))}).map(function(details){return Object.assign(details,{key:Array.from(details.data.values()).map(function(runs){return runs.map(function(run){return run.directionId+'/'+run.time}).join(',')}).join(';')})});var groupedData=new Map;parsedData.forEach(function(day){if(groupedData.has(day.key)){groupedData.get(day.key).dates.set(day.date,Array.from(day.data.keys()))}else{groupedData.set(day.key,{dates:new Map([[day.date,Array.from(day.data.keys())]]),timetable:Array.from(day.data.values()),maxCols:day.maxCols})}});return Array.from(groupedData.values())}document.addEventListener('DOMContentLoaded',function(){document.getElementById('lineChooser').addEventListener('change',function(){onLineChange()});document.getElementById('dateChooser').addEventListener('change',function(){onDateChange()});fetchPromise.then(function(_){return onLineChange()})});function onLineChange(){var lineChooser=document.getElementById('lineChooser');var dateChooser=document.getElementById('dateChooser');var originalDate=dateChooser.value;var dates=['\u663E\u793A\u6240\u6709\u65E5\u671F'].concat(Object.keys(allData[allLines[lineChooser.value][0].guid]).sort());fillSelect(dateChooser,dates,['all']);if(dates.includes(originalDate))dateChooser.value=originalDate;onDateChange()}function renderTimeTableRow(runs,maxCols){var tds=[];var currentDirection=0;var colCount=0;runs.forEach(function(details){if(currentDirection!=details.directionId){tds.push(createElement('td'));++colCount}currentDirection=details.directionId==1?0:1;tds.push(createElement('td',details.time));++colCount});for(var i=0;i<maxCols-colCount;++i){tds.push(createElement('td'))}return tds}function onDateChange(){var lineChooser=document.getElementById('lineChooser');var dateChooser=document.getElementById('dateChooser');var content=document.getElementById('content');if(dateChooser.value=='all'){var _data=parseLine(lineChooser.value);removeChildren(content);_data.forEach(function(cur){var header1=createElement('tr',[createElement('th','\u65E5\u671F',{rowSpan:2})].concat(_toConsumableArray(Array.from(cur.dates.keys()).map(function(date){return createElement('th',date,{rowSpan:2})})),[createElement('th','\u53D1\u8F66\u65F6\u95F4',{colSpan:cur.maxCols})]));var directions=allLines[lineChooser.value];var directionShortNames=[directions[0].direction,directions[1].direction];for(var i=0;i<Math.min(directionShortNames[0].length,directionShortNames[1].length);++i){if(directionShortNames[0][i]==directionShortNames[1][i])continue;directionShortNames[0]=directionShortNames[0].substr(0,i+1);directionShortNames[1]=directionShortNames[1].substr(0,i+1)}var header2=createElement('tr',new Array(cur.maxCols).fill(0).map(function(_,i){return createElement('th',directionShortNames[i%2],{title:directions[i%2].direction})}));var allLicenseIds=Array.from(Array.from(cur.dates.values()).reduce(function(set,cur){return cur.forEach(function(licenseId){return set.add(licenseId)}),set},new Set)).sort();appendChildren(content,[createElement('table',[createElement('thead',[header1,header2]),createElement('tbody',cur.timetable.map(function(runs,timetableIndex){return createElement('tr',[].concat(_toConsumableArray(timetableIndex==0?[createElement('th','\u8F66\u724C\u53F7',{rowSpan:cur.timetable.length})]:[]),_toConsumableArray(Array.from(cur.dates.values()).map(function(licenseIds){var lindex=allLicenseIds.indexOf(licenseIds[timetableIndex]);var attr={};if(lindex>=0&&lindex<PALETTE.length)attr.style='background-color:'+PALETTE[lindex];return createElement('td',licenseIds[timetableIndex],attr)})),_toConsumableArray(renderTimeTableRow(runs,cur.maxCols))))}))],{border:1}),createElement('p')])});return}var _parseByLineDate=parseByLineDate(lineChooser.value,dateChooser.value),maxCols=_parseByLineDate.maxCols,data=_parseByLineDate.data;var headerBasic=createElement('tr',[createElement('th','\u8F66\u724C\u53F7',{rowSpan:2}),createElement('th','\u53D1\u8F66\u65F6\u95F4',{colSpan:maxCols})]);var headerDirections=createElement('tr');var directions=allLines[lineChooser.value];var directionShortNames=[directions[0].direction,directions[1].direction];for(var i=0;i<Math.min(directionShortNames[0].length,directionShortNames[1].length);++i){if(directionShortNames[0][i]==directionShortNames[1][i])continue;directionShortNames[0]=directionShortNames[0].substr(0,i+1);directionShortNames[1]=directionShortNames[1].substr(0,i+1)}for(var _i=0;_i<maxCols;++_i){headerDirections.appendChild(createElement('th',directionShortNames[_i%2],{title:directions[_i%2].direction}))}var thead=createElement('thead',[headerBasic,headerDirections]);var tbody=createElement('tbody');var _loop2=function _loop2(licenseId,_runs2){var tr=createElement('tr',[createElement('td',licenseId)]);var currentDirection=0;var colCount=0;_runs2.forEach(function(details){if(currentDirection!=details.directionId){tr.appendChild(createElement('td'));++colCount}currentDirection=details.directionId==1?0:1;tr.appendChild(createElement('td',details.time));++colCount});for(var _i2=0;_i2<maxCols-colCount;++_i2){tr.appendChild(createElement('td'))}tbody.appendChild(tr)};var _iteratorNormalCompletion2=true;var _didIteratorError2=false;var _iteratorError2=undefined;try{for(var _iterator2=data[Symbol.iterator](),_step2;!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=true){var _ref3=_step2.value;var _ref4=_slicedToArray(_ref3,2);var licenseId=_ref4[0];var _runs2=_ref4[1];_loop2(licenseId,_runs2)}}catch(err){_didIteratorError2=true;_iteratorError2=err}finally{try{if(!_iteratorNormalCompletion2&&_iterator2['return']){_iterator2['return']()}}finally{if(_didIteratorError2){throw _iteratorError2}}}replaceChildren(document.getElementById('content'),createElement('table',[thead,tbody],{border:1}))}

//# sourceMappingURL=wj_timetable.min.js.map