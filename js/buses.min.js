'use strict';var COLOR=[106,90,205],PALETTE=[[230,25,75],[60,180,75],[255,225,25],[0,130,200],[245,130,48],[145,30,180],[70,240,240],[240,50,230],[210,245,60],[250,190,190],[0,128,128],[170,110,40],[128,0,0],[170,255,195],[128,128,0],[0,0,128],[128,128,128]],lineData={},lineNameMap={},lineSourceMap={},activeLines=[];function loadData(){function a(a,b,d){var e=c[a].total;if(c[a].total=d,c[a].loaded=b,e!=d){var f=1,g=0;for(var h in c)0==c[h].total?f-=c[h].weight:g+=c[h].total;for(var h in c)0!=c[h].total&&(c[h].weight=f*c[h].total/g)}var i=0;for(var h in c)0!=c[h].total&&(i+=c[h].loaded/c[h].total*c[h].weight);1<i&&(i=1),document.getElementById('progressbar').style.width=100*i+'%',document.getElementById('progressbar').innerText='Loading...'+Math.round(100*i)+'%'}var b={};manifest.sources.forEach(function(a){lineNameMap[a]={},manifest.lines[a]&&manifest.lines[a].forEach(function(c){if('__+BEGIN_LINES+__'!=c&&'__+END_LINES+__'!=c&&b[c]){var d;for(d=2;b[c+'_'+d];++d);b[c+'_'+d]=!0,lineNameMap[a][c]=c+'_'+d}else b[c]=!0})});var c={};if(manifest.sources.forEach(function(a){c[a]={total:0,loaded:0,weight:1/manifest.sources.length}}),manifest.size_hints){var d=0;for(var e in manifest.size_hints)manifest.size_hints[e]?d+=manifest.size_hints[e]:remainingProgress-=1/manifest.sources.length;for(var e in manifest.size_hints)manifest.size_hints[e]&&(c[e].weight=1*manifest.size_hints[e]/d)}Promise.all(manifest.sources.map(function(b){return new Promise(function(c){var d=manifest.data[b],e=new XMLHttpRequest;e.open('GET',d,!0),e.onreadystatechange=function(){if(4==e.readyState&&200==e.status){var d=e.responseText;-1!=d.indexOf('__BUS_LINE_DATA')&&(d=d.replace(/var __BUS_LINE_DATA=JSON\.parse\('|\\\n|'\)$/g,''));var f=JSON.parse(d);for(var g in f){var h=g;lineNameMap[b]&&lineNameMap[b][g]&&(h=lineNameMap[b][g]);var j=f[g];if(lineData[h]){console.warn('New line name conflict!');var k;for(k=2;lineData[h+'_'+k];++k);lineData[h+'_'+k]=j}else lineData[h]=j}a(b,1,1),c()}else 4==e.readyState&&c()},e.onprogress=function(c){c.lengthComputable&&a(b,c.loaded,c.total)},e.send()})})).then(function(){document.getElementById('progress').style.display='none',initializeLineChooser()})}function initializeLineChooser(){var a=document.getElementById('lineChooser');Object.keys(lineData).sort(function(c,a){var b,d=parseInt(c),e=parseInt(a);return b=c<a?-1:c>a?1:0,isNaN(d)&&isNaN(e)?b:isNaN(d)&&!isNaN(e)?1:!isNaN(d)&&isNaN(e)?-1:d<e?-1:d>e?1:b}).forEach(function(b){var c=document.createElement('option');c.value=b,c.appendChild(document.createTextNode(b)),a.appendChild(c)}),parseUrlHash()||showLine(a.children[0].value)}function fillTr(a,b,c){var d=document.createElement('tr');return Array.prototype.forEach.call(a,function(a,e){var f=document.createElement(b?'th':'td');if(c&&c[e])for(var g in c[e])f.setAttribute(g,c[e][g]);f.appendChild(document.createTextNode(a)),d.appendChild(f)}),d}function removeChildren(a){for(;a.hasChildNodes();)a.removeChild(a.childNodes[0])}function showLine(a){activeLines=[a];var b=document.getElementById('content');if(removeChildren(b),!lineData[a])return void b.appendChild(document.createTextNode('Line '+a+' does not exist!'));var c=document.createElement('table'),d=document.createElement('thead');d.appendChild(fillTr(['Bus ID'].concat(lineData[a].buses.map(function(a){return a.busId})),!0)),d.appendChild(fillTr(['License ID'].concat(lineData[a].buses.map(function(a){return a.licenseId})),!0)),c.appendChild(d);var e=document.createElement('tbody');lineData[a].details.forEach(function(a){e.appendChild(fillTr([a[0]].concat(Array(a[1].length).fill('')),!1,[''].concat(a[1].map(function(a){return{style:'background-color:rgb('+COLOR.map(function(b){return parseInt((255-b)*(1-a)+b)}).join(',')+')'}}))))}),c.appendChild(e),b.appendChild(c)}function busCompareFunction(a){return 6==a.length?function(b){return b.busId[0]==a[0]&&b.busId.substr(2)==a.substr(2)}:function(b){return b.licenseId==a.substr(Math.max(a.length-5,0))}}function findBusById(a){var b=document.getElementById('resultList');for(var c in removeChildren(b),lineData)if(lineData[c].buses.some(busCompareFunction(a))){var d=document.createElement('option');d.value=c,d.appendChild(document.createTextNode(c)),b.appendChild(d)}}function showLines(a){var b=document.getElementById('content'),c=document.getElementById('legend');if(removeChildren(b),removeChildren(c),a.length>PALETTE.length)return void b.appendChild(document.createTextNode('Too many lines selected!'));if(a.some(function(a){return!lineData[a]}))return void b.appendChild(document.createTextNode('Not all lines exist!'));for(var d=0;d<a.length;++d){var e=document.createElement('span'),f=document.createElement('span');f.style.backgroundColor='rgb('+PALETTE[d].join(',')+')',f.style.height='1em',f.style.width='2em',f.style.display='inline-block',e.style.marginLeft='3em',e.appendChild(f),e.appendChild(document.createTextNode(' '+a[d])),c.appendChild(e)}for(var g=[],h=new Set,i={},d=0;d<a.length;++d)currentLineData=lineData[a[d]],currentLineData.buses.forEach(function(a){h.has(a.licenseId)||(g.push(a),h.add(a.licenseId))}),currentLineData.details.forEach(function(b){i[b[0]]||(i[b[0]]={});for(var c,e=0;e<currentLineData.buses.length;++e)c=currentLineData.buses[e].licenseId,i[b[0]][c]||(i[b[0]][c]=Array(a.length).fill(0)),i[b[0]][c][d]=b[1][e]});g.sort(function(c,a){return c.busId&&a.busId?c.busId<a.busId?-1:c.busId>a.busId?1:0:c.busId&&!a.busId?-1:!c.busId&&a.busId?1:c.licenseId<a.licenseId?-1:c.licenseId>a.licenseId?1:0});var j=document.createElement('table'),k=document.createElement('thead');k.appendChild(fillTr(['Bus ID'].concat(g.map(function(a){return a.busId})),!0)),k.appendChild(fillTr(['License ID'].concat(g.map(function(a){return a.licenseId})),!0)),j.appendChild(k);var l=document.createElement('tbody');Object.keys(i).sort().forEach(function(b){var c=document.createElement('tr'),d=document.createElement('th');d.appendChild(document.createTextNode(b)),c.appendChild(d),g.forEach(function(d){var e=document.createElement('td');c.appendChild(e);var f=0;i[b][d.licenseId]&&(f=i[b][d.licenseId].filter(function(a){return 0<a}).length),0==f||i[b][d.licenseId].forEach(function(b,c){if(0<b){var d=document.createElement('span');d.style.height='100%',d.style.width='calc(100%/'+f+')',d.style.display='inline-block',d.style.backgroundColor='rgb('+PALETTE[c].map(function(a){return parseInt((255-a)*(1-b)+a)}).join(',')+')',d.appendChild(document.createTextNode('\xA0')),d.setAttribute('data-line',a[c]),e.appendChild(d)}})}),l.appendChild(c)}),j.appendChild(l),b.appendChild(j)}function onChooseLine(){if(document.getElementById('compare').checked){if(activeLines.includes(this.value))return;activeLines.push(this.value),history.pushState(activeLines,'','#'+activeLines.join('+')),showLines(activeLines)}else{var a=this.value;showLine(a),history.pushState(a,'','#'+a)}}function loadDataFromFile(a,b){var c=document.createElement('script');c.type='text/javascript',c.src=a,document.head.appendChild(c),c.onload=function(){b(__BUS_LINE_DATA,a)}}function parseUrlHash(){if(location.hash.replace('#','')){var a=location.hash.replace('#','');return a.includes('+')?(activeLines=a.split('+'),showLines(a.split('+'))):showLine(lineChooser.value=a),!0}}document.addEventListener('DOMContentLoaded',function(){function a(a,b,c){var d=document.getElementById('cellDetails');if('none'!=d.style.display){var e=document.getElementById('cellLineContainer'),f=a;'span'==f.tagName.toLowerCase()?(f=f.parentElement,e.style.display='',document.getElementById('cellLine').innerText=a.getAttribute('data-line')):e.style.display='none',document.getElementById('cellDate').innerText=f.parentElement.children[0].innerText;var g=document.getElementById('content').querySelector('table thead');document.getElementById('cellBusId').innerText=g.children[0].children[f.cellIndex].innerText,document.getElementById('cellLicenseId').innerText=g.children[1].children[f.cellIndex].innerText,d.style.left=b+document.body.scrollLeft+document.documentElement.scrollLeft+8+'px',d.style.top=c+document.body.scrollTop+document.documentElement.scrollTop+8+'px'}}function b(){var a=document.getElementById('cellDetails');a.style.display='none'!=a.style.display||document.getElementById('disableInfotip').checked?'none':''}var c=Math.max;loadData(),lineChooser.addEventListener('change',onChooseLine),document.getElementById('resultList').addEventListener('change',onChooseLine),window.onpopstate=function(a){a.state instanceof Array?(activeLines=a.state,showLines(activeLines)):a.state?showLine(a.state):parseUrlHash()},document.getElementById('busid').addEventListener('input',function(){findBusById(this.value)}),document.getElementById('findRecent').addEventListener('click',function(){var a=parseInt(document.getElementById('findRecentDays').value)||15,b=document.getElementById('busid').value,d={};[].map.call(document.getElementById('resultList').children,function(a){return a.value}).forEach(function(e){for(var f=lineData[e].details,g=lineData[e].buses.findIndex(busCompareFunction(b)),h=c(f.length-a,0);h<f.length;++h){var i=f[h][0],j=f[h][1][g];if(j){var k={line:e,weight:j};d[i]?d[i].push(k):d[i]=[k]}}});var e=Object.keys(d).sort();e=e.slice(c(e.length-a,0)),alert(e.map(function(a){return a+': '+d[a].map(function(a){return a.line+' ('+a.weight+')'}).join(', ')}).join('\n'))}),['click','mousedown','mouseup','touchstart','touchend'].forEach(function(a){document.getElementById('findRecentDays').addEventListener(a,function(a){a.stopPropagation()})}),document.getElementById('content').addEventListener('click',function(c){var d=c.target?c.target.tagName.toLowerCase():'';('span'==d||'td'==d)&&(b(),a(c.target,c.clientX,c.clientY))});var d=!1;document.getElementById('content').addEventListener('touchstart',function(c){var e=c.target?c.target.tagName.toLowerCase():'';('span'==e||'td'==e)&&(c.preventDefault(),a(c.target,c.touches[0].clientX,c.touches[0].clientY),!d&&(d=!0,window.setTimeout(function(){d&&(b(),a(c.target,c.touches[0].clientX,c.touches[0].clientY))},1500)))}),document.getElementById('content').addEventListener('touchend',function(a){var b=a.target?a.target.tagName.toLowerCase():'';('span'==b||'td'==b)&&(a.preventDefault(),d=!1)}),document.getElementById('content').addEventListener('mouseover',function(b){var c=b.target?b.target.tagName.toLowerCase():'';('span'==c||'td'==c)&&a(b.target,b.clientX,b.clientY)}),document.getElementById('startDate').value='2018-01-01';var e=new Date;e.setMinutes(e.getMinutes()-e.getTimezoneOffset()),document.getElementById('endDate').value=e.toISOString().substr(0,10)}),'serviceWorker'in navigator&&navigator.serviceWorker.register('/service_worker.js');

//# sourceMappingURL=buses.min.js.map