function _asyncToGenerator(a){return function(){var b=a.apply(this,arguments);return new Promise(function(a,c){function d(e,f){try{var g=b[e](f),h=g.value}catch(a){return void c(a)}return g.done?void a(h):Promise.resolve(h).then(function(a){d('next',a)},function(a){d('throw',a)})}return d('next')})}}class DateUtils{static formatNumber_(a){let b=a.toString();return 1==b.length?'0'+b:b}static formatDate(a,b,c){let d=a.toString();return b&&(d+='-'+DateUtils.formatNumber_(b)),c&&(d+='-'+DateUtils.formatNumber_(c)),d}static toYearMonth(a){let b=a.indexOf('-');if(-1==b)return a;let c=a.indexOf('-',b+1);return-1==c?a:a.substr(0,c)}static nextMonth(a){let b=a.split('-');return b[1]++,12<b[1]&&(b[0]+=b[1]/12,b[1]%=12),b[2]&&b[2]>DateUtils.daysInMonthsMap_[b[1]]&&(b[2]=DateUtils.daysInMonthsMap_[b[1]]),DateUtils.formatDate.apply(null,b)}static previousMonth(a){let b=a;return'string'==typeof a&&(b=a.split('-')),b[1]--,0==b[1]&&(b[0]--,b[1]=12),b[2]&&b[2]>DateUtils.daysInMonthsMap_[b[1]]&&(b[2]=DateUtils.daysInMonth(b[1])),DateUtils.formatDate.apply(null,b)}static yesterday(a){let b=a.split('-');if(b[2]--,0==b[2]){let a=DateUtils.previousMonth(b.slice(0,2)),c=a.split('-');return a+'-'+DateUtils.formatNumber_(DateUtils.daysInMonth(c[0],c[1]))}}static isLeapYear(a){return a=parseInt(a),0==a%400||0!=a%100&&0==a%4}static daysInMonth(a,b){return b=parseInt(b),2==b&&isLeapYear(a)?29:DateUtils.daysInMonthsMap_[b]}}DateUtils.daysInMonthsMap_=[void 0,31,28,31,30,31,30,31,31,30,31,30,31];class LineDataManager{constructor(a){this.manifest=a,this.loadedLineData_={},this.lineData_={};let b=new Date;b.setMinutes(b.getMinutes()-b.getTimezoneOffset()),this.today_=b.toISOString().substr(0,10),this.earliestDate=Object.keys(a.archives||{}).map((b)=>a.archives[b].start_date).concat([a.start_date]).reduce((a,b)=>b<a?b:a,'9999-99-99'),this.initializeLineNameMap_(a)}initializeLineNameMap_(a){this.lineNameMap_={};let b={};a.sources.forEach((c)=>{this.lineNameMap_[c]={},a.lines[c]&&a.lines[c].forEach((a)=>{if('__+BEGIN_LINES+__'!=a&&'__+END_LINES+__'!=a&&b[a]){let d;for(d=2;b[a+'_'+d];++d);b[a+'_'+d]=!0,this.lineNameMap_[c][a]=a+'_'+d}else b[a]=!0})})}appendLineDataToLoad_(a,b,c){return'string'==typeof c?c=[c]:void 0==c&&(c=this.manifest.sources),Array.prototype.push.apply(a,c.filter((a)=>!this.loadedLineData_[b]||!this.loadedLineData_[b][a]).map((a)=>({month:b,source:a}))),a}isRangeOverlapped_(a,b,c,d){return a<=d&&b>=c}load(a,b){var c=this;return _asyncToGenerator(function*(){let d=[];if(c.isRangeOverlapped_(a,b,c.manifest.start_date,c.today_)&&c.appendLineDataToLoad_(d,'current'),a<c.manifest.start_date&&(a<c.earliestDate&&(a=c.earliestDate),b>=c.manifest.start_date&&(b=DateUtils.yesterday(c.manifest.start_date)),a<=b)){let e=DateUtils.toYearMonth(a),f=DateUtils.toYearMonth(b),g=Object.keys(c.manifest.archives||{}).map(function(a){let b=Object.assign({},c.manifest.archives[a],{name:a});return b.start_month=DateUtils.toYearMonth(b.start_date),b.end_month=DateUtils.toYearMonth(b.end_date),b}).filter(function(d){return c.isRangeOverlapped_(a,b,d.start_date,d.end_date)});for(let e=DateUtils.toYearMonth(a);e<=DateUtils.toYearMonth(b);e=DateUtils.nextMonth(e))c.appendLineDataToLoad_(d,e,g.filter(function(a){return e>=a.start_month&&e<=a.end_month}).map(function(a){return a.name}))}for(let a of d){let b;b='current'==a.month?c.manifest.data[a.source]:c.manifest.archives[a.source].path+a.month.replace('-','')+'.json',yield fetch(b).then(function(a){return a.json()}).then(function(b){c.loadedLineData_[a.month]||(c.loadedLineData_[a.month]={}),c.loadedLineData_[a.month][a.source]=b,c.importData_(a.month,a.source),a.loaded=!0,c.onUpdateProgress&&c.onUpdateProgress(d,a.month,a.source,1,1)}).catch(function(){return a.loaded=!1},Promise.resolve())}return d})()}importData_(a,b){let c=this.loadedLineData_[a][b];Object.keys(c).forEach((d)=>{let e=this.lineNameMap_[b][d]||d;this.lineData_[e]||(this.lineData_[e]={}),this.lineData_[e][a]=c[d]})}query(a,b,c){'string'==typeof a&&(a=[a]);let d={},e={};a.forEach((f,g)=>{Object.keys(this.lineData_[f]).filter((a)=>'current'==a?this.isRangeOverlapped_(b,c,this.manifest.start_date,this.today_):DateUtils.toYearMonth(b)<=a&&DateUtils.toYearMonth(c)>=a).sort().forEach((h)=>{let j=this.lineData_[f][h];j.buses.forEach((a)=>{d[a.licenseId]?d[a.licenseId].busId!=a.busId&&(d[a.licenseId].busId=a.busId):d[a.licenseId]=Object.assign({},a)}),j.details.filter((a)=>a[0]>=b&&a[0]<=c).forEach((b)=>{e[b[0]]||(e[b[0]]={});for(let c,f=0;f<j.buses.length;++f){c=j.buses[f].licenseId,e[b[0]][c]||(e[b[0]][c]=Array(a.length).fill(0));let h=b[1][f];e[b[0]][c][g]=h,0<h&&(d[c].hasWeight=!0)}})})});let f=Object.keys(d).filter((a)=>d[a].hasWeight).sort((c,e)=>{let f=d[c],a=d[e];if(f.busId&&a.busId)return f.busId<a.busId?-1:f.busId>a.busId?1:0;return f.busId&&!a.busId?-1:!f.busId&&a.busId?1:f.licenseId<a.licenseId?-1:f.licenseId>a.licenseId?1:0}).map((a)=>d[a]),g=Array(a.length).fill(0),h=Object.keys(e).sort().map((a)=>[a,f.map((b)=>e[a][b.licenseId]||g)]);return{buses:f,details:h}}contains(a){return'string'==typeof a&&(a=[a]),!a.some((a)=>!this.lineData_[a])}getLines(c){return Object.keys(this.lineData_).sort((d,a)=>{let b,e=parseInt(d),f=parseInt(a);return b=d<a?-1:d>a?1:0,c?isNaN(e)&&isNaN(f)?b:isNaN(e)&&!isNaN(f)?1:!isNaN(e)&&isNaN(f)?-1:e<f?-1:e>f?1:b:b})}}const COLOR=[106,90,205],PALETTE=[[230,25,75],[60,180,75],[255,225,25],[0,130,200],[245,130,48],[145,30,180],[70,240,240],[240,50,230],[210,245,60],[250,190,190],[0,128,128],[170,110,40],[128,0,0],[170,255,195],[128,128,0],[0,0,128],[128,128,128]];let currentStartDate,currentEndDate,lineDataManager=new LineDataManager(manifest),activeLines=[];var lineData={},lineNameMap={};(function(){var a=new Date;a.setMinutes(a.getMinutes()-a.getTimezoneOffset()),currentEndDate=a.toISOString().substr(0,10);var b=a.getMonth();a.setMonth(a.getMonth()-1),b==a.getMonth()&&a.setDate(0),currentStartDate=a.toISOString().substr(0,10)})();function loadData(){function a(a,b,d){var e=c[a].total;if(c[a].total=d,c[a].loaded=b,e!=d){var f=1,g=0;for(var h in c)0==c[h].total?f-=c[h].weight:g+=c[h].total;for(var h in c)0!=c[h].total&&(c[h].weight=f*c[h].total/g)}var i=0;for(var h in c)0!=c[h].total&&(i+=c[h].loaded/c[h].total*c[h].weight);1<i&&(i=1),isNaN(i)&&(i=0),document.getElementById('progressbar').style.width=100*i+'%',document.getElementById('progressbar').innerText='Loading...'+Math.round(100*i)+'%'}var b={};manifest.sources.forEach(function(a){lineNameMap[a]={},manifest.lines[a]&&manifest.lines[a].forEach(function(c){if('__+BEGIN_LINES+__'!=c&&'__+END_LINES+__'!=c&&b[c]){var d;for(d=2;b[c+'_'+d];++d);b[c+'_'+d]=!0,lineNameMap[a][c]=c+'_'+d}else b[c]=!0})});var c={};if(manifest.sources.forEach(function(a){c[a]={total:0,loaded:0,weight:1/manifest.sources.length}}),manifest.size_hints){var d=0;for(var e in manifest.size_hints)manifest.size_hints[e]?d+=manifest.size_hints[e]:remainingProgress-=1/manifest.sources.length;for(var e in manifest.size_hints)manifest.size_hints[e]&&(c[e].weight=1*manifest.size_hints[e]/d)}Promise.all(manifest.sources.map(function(b){return new Promise(function(c){var d=manifest.data[b],e=new XMLHttpRequest;e.open('GET',d,!0),e.onreadystatechange=function(){if(4==e.readyState&&200==e.status){var d=e.responseText;-1!=d.indexOf('__BUS_LINE_DATA')&&(d=d.replace(/var __BUS_LINE_DATA=JSON\.parse\('|\\\n|'\)$/g,''));var f=JSON.parse(d);for(var g in f){var h=g;lineNameMap[b]&&lineNameMap[b][g]&&(h=lineNameMap[b][g]);var j=f[g];if(lineData[h]){console.warn('New line name conflict!');var k;for(k=2;lineData[h+'_'+k];++k);lineData[h+'_'+k]=j}else lineData[h]=j}a(b,1,1),c()}else 4==e.readyState&&c()},e.onprogress=function(c){c.lengthComputable&&a(b,c.loaded,c.total)},e.send()})})).then(function(){document.getElementById('progress').style.display='none',updateLineChooser(lineDataManager.getLines()),parseUrlHash()||showLinesNew(lineChooser.children[0].value),loadRemoteManifest()})}function loadRemoteManifest(){fetch('manifest.json',{cache:'no-cache'}).then((a)=>a.json()).then((a)=>{document.getElementById('last_update_container').style.display='',document.getElementById('last_update_time').appendChild(document.createTextNode(a.last_update_time))}).catch(()=>{document.getElementById('offline_prompt').style.display=''})}function isBusIdContinuous(c,a){if(c.substr(0,2)!=a.substr(0,2))return!1;var b=parseInt(c.substr(2)),d=parseInt(a.substr(2));if(b==d+1||d==b+1)return!0;return!('5-'!=c.substr(0,2)||(3!=b%10||b+2!=d)&&(3!=d%10||d+2!=b))}function updateLineChooser(a){var b=document.getElementById('lineChooser');a.forEach((a)=>{let c=document.createElement('option');c.value=a,c.appendChild(document.createTextNode(a)),b.appendChild(c)})}function fillTr(a,b,c){var d=document.createElement('tr');return Array.prototype.forEach.call(a,function(a,e){var f=document.createElement(b?'th':'td');if(c&&c[e])for(var g in c[e])f.setAttribute(g,c[e][g]);f.appendChild(document.createTextNode(a)),d.appendChild(f)}),d}function removeChildren(a){for(;a.hasChildNodes();)a.removeChild(a.childNodes[0])}function createTableHeader(a){var b=document.createElement('thead'),c=document.createElement('tr'),d=document.createElement('th');d.appendChild(document.createTextNode('Bus ID')),c.appendChild(d);for(var e,f=null,g=!1,h=!1,j='',k=0;k<a.length;++k)e=document.createElement('th'),e.appendChild(document.createTextNode(a[k].busId)),c.appendChild(e),j=h?'busid_odd_range_element':'busid_even_range_element',0<k&&isBusIdContinuous(a[k-1].busId,a[k].busId)?g?f.className=j:(f.className='busid_range_begin '+j,g=!0):g&&(g=!1,f.className='busid_range_end '+j,h=!h),f=e;return g&&(f.className='busid_range_end '+j),b.appendChild(c),b.appendChild(fillTr(['License ID'].concat(a.map((a)=>a.licenseId)),!0)),b}function getFilteredLineData(a){if('string'==typeof a){var b=lineData[a].details.filter((a)=>a[0]>=currentStartDate&&a[0]<=currentEndDate).slice(),c=lineData[a].buses,d=Array(c.length).fill(0);b.forEach((a)=>a[1].forEach((a,b)=>d[b]+=a));var e=(a,b)=>0<d[b];return{buses:c.filter(e),details:b.map((a)=>[a[0],a[1].filter(e)])}}console.error('Not implemented')}function showLine(a){activeLines=[a];var b=document.getElementById('content');if(removeChildren(b),!lineData[a])return void b.appendChild(document.createTextNode('Line '+a+' does not exist!'));var c=getFilteredLineData(a),d=document.createElement('table');d.appendChild(createTableHeader(c.buses));var e=document.createElement('tbody');c.details.forEach(function(a){e.appendChild(fillTr([a[0]].concat(Array(a[1].length).fill('')),!1,[''].concat(a[1].map(function(a){return{style:'background-color:rgb('+COLOR.map(function(b){return parseInt((255-b)*(1-a)+b)}).join(',')+')'}}))))}),d.appendChild(e),b.appendChild(d)}function busCompareFunction(a){return 6==a.length?function(b){return b.busId[0]==a[0]&&b.busId.substr(2)==a.substr(2)}:function(b){return b.licenseId==a.substr(Math.max(a.length-5,0))}}function findBusById(a){var b=document.getElementById('resultList');for(var c in removeChildren(b),lineData)if(lineData[c].buses.some(busCompareFunction(a))){var d=document.createElement('option');d.value=c,d.appendChild(document.createTextNode(c)),b.appendChild(d)}}function showLinesNew(a){'string'==typeof a&&(a=[a]);let b=document.getElementById('content'),c=document.getElementById('legend');if(removeChildren(b),removeChildren(c),a.length>PALETTE.length)return void b.appendChild(document.createTextNode('Too many lines selected!'));if(!lineDataManager.contains(a))return void b.appendChild(document.createTextNode('Not all lines exist!'));1<a.length&&a.forEach((a,b)=>{let d=document.createElement('span'),e=document.createElement('span');e.style.backgroundColor='rgb('+PALETTE[b].join(',')+')',e.style.height='1em',e.style.width='2em',e.style.display='inline-block',d.style.marginLeft='3em',d.appendChild(e),d.appendChild(document.createTextNode(' '+a)),c.appendChild(d)});let d=lineDataManager.query(a,currentStartDate,currentEndDate),e=document.createElement('table');e.appendChild(createTableHeader(d.buses));let f=document.createElement('tbody');d.details.forEach((b)=>{var c=document.createElement('tr'),e=document.createElement('th');e.appendChild(document.createTextNode(b[0])),c.appendChild(e),d.buses.forEach((d,e)=>{var f=document.createElement('td');c.appendChild(f);var g=0;g=b[1][e].filter((a)=>0<a).length,0==g||b[1][e].forEach((b,c)=>{if(0<b){var d=document.createElement('span');d.style.height='100%',d.style.width=100/g+'%',d.style.display='inline-block',d.style.backgroundColor='rgb('+(1==a.length?COLOR:PALETTE[c]).map((a)=>parseInt((255-a)*(1-b)+a)).join(',')+')',d.appendChild(document.createTextNode('\xA0')),d.setAttribute('data-line',a[c]),f.appendChild(d)}})}),f.appendChild(c)}),e.appendChild(f),b.appendChild(e)}function showLines(a){var b=document.getElementById('content'),c=document.getElementById('legend');if(removeChildren(b),removeChildren(c),a.length>PALETTE.length)return void b.appendChild(document.createTextNode('Too many lines selected!'));if(a.some(function(a){return!lineData[a]}))return void b.appendChild(document.createTextNode('Not all lines exist!'));for(var d=0;d<a.length;++d){var e=document.createElement('span'),f=document.createElement('span');f.style.backgroundColor='rgb('+PALETTE[d].join(',')+')',f.style.height='1em',f.style.width='2em',f.style.display='inline-block',e.style.marginLeft='3em',e.appendChild(f),e.appendChild(document.createTextNode(' '+a[d])),c.appendChild(e)}for(var g=[],h=new Set,i={},d=0;d<a.length;++d)currentLineData=lineData[a[d]],currentLineData.buses.forEach(function(a){h.has(a.licenseId)||(g.push(a),h.add(a.licenseId))}),currentLineData.details.forEach(function(b){i[b[0]]||(i[b[0]]={});for(var c,e=0;e<currentLineData.buses.length;++e)c=currentLineData.buses[e].licenseId,i[b[0]][c]||(i[b[0]][c]=Array(a.length).fill(0)),i[b[0]][c][d]=b[1][e]});g.sort(function(c,a){return c.busId&&a.busId?c.busId<a.busId?-1:c.busId>a.busId?1:0:c.busId&&!a.busId?-1:!c.busId&&a.busId?1:c.licenseId<a.licenseId?-1:c.licenseId>a.licenseId?1:0});var j=document.createElement('table');j.appendChild(createTableHeader(g));var k=document.createElement('tbody');Object.keys(i).sort().forEach(function(b){var c=document.createElement('tr'),d=document.createElement('th');d.appendChild(document.createTextNode(b)),c.appendChild(d),g.forEach(function(d){var e=document.createElement('td');c.appendChild(e);var f=0;i[b][d.licenseId]&&(f=i[b][d.licenseId].filter(function(a){return 0<a}).length),0==f||i[b][d.licenseId].forEach(function(b,c){if(0<b){var d=document.createElement('span');d.style.height='100%',d.style.width='calc(100%/'+f+')',d.style.display='inline-block',d.style.backgroundColor='rgb('+PALETTE[c].map(function(a){return parseInt((255-a)*(1-b)+a)}).join(',')+')',d.appendChild(document.createTextNode('\xA0')),d.setAttribute('data-line',a[c]),e.appendChild(d)}})}),k.appendChild(c)}),j.appendChild(k),b.appendChild(j)}function onChooseLine(){if(document.getElementById('compare').checked){if(activeLines.includes(this.value))return;activeLines.push(this.value),history.pushState(activeLines,'','#'+activeLines.join('+')),showLinesNew(activeLines)}else{var a=this.value;showLinesNew(a),history.pushState(a,'','#'+a)}}function parseUrlHash(){if(location.hash.replace('#','')){var a=location.hash.replace('#','');return a.includes('+')?(activeLines=a.split('+'),showLinesNew(a.split('+'))):showLinesNew(lineChooser.value=a),!0}}function init(){function a(a,b,c){var d=document.getElementById('cellDetails');if('none'!=d.style.display){var e=document.getElementById('cellLineContainer'),f=a;'span'==f.tagName.toLowerCase()?(f=f.parentElement,e.style.display='',document.getElementById('cellLine').innerText=a.getAttribute('data-line')):e.style.display='none',document.getElementById('cellDate').innerText=f.parentElement.children[0].innerText;var g=document.getElementById('content').querySelector('table thead');document.getElementById('cellBusId').innerText=g.children[0].children[f.cellIndex].innerText,document.getElementById('cellLicenseId').innerText=g.children[1].children[f.cellIndex].innerText,d.style.left=b+document.body.scrollLeft+document.documentElement.scrollLeft+8+'px',d.style.top=c+document.body.scrollTop+document.documentElement.scrollTop+8+'px'}}function b(){var a=document.getElementById('cellDetails');a.style.display='none'!=a.style.display||document.getElementById('disableInfotip').checked?'none':''}var c=Math.max;lineDataManager.load(currentStartDate,currentEndDate).then(()=>{document.getElementById('progress').style.display='none',updateLineChooser(lineDataManager.getLines()),parseUrlHash()||showLinesNew(document.getElementById('lineChooser').children[0].value),loadRemoteManifest()}),document.getElementById('startDate').value=currentStartDate,document.getElementById('endDate').value=currentEndDate,lineChooser.addEventListener('change',onChooseLine),document.getElementById('resultList').addEventListener('change',onChooseLine),window.onpopstate=function(a){a.state instanceof Array?(activeLines=a.state,showLinesNew(activeLines)):a.state?showLinesNew(a.state):parseUrlHash()},document.getElementById('busid').addEventListener('input',function(){findBusById(this.value)}),document.getElementById('findRecent').addEventListener('click',function(){var a=parseInt(document.getElementById('findRecentDays').value)||15,b=document.getElementById('busid').value,d={};[].map.call(document.getElementById('resultList').children,function(a){return a.value}).forEach(function(e){for(var f=lineData[e].details,g=lineData[e].buses.findIndex(busCompareFunction(b)),h=c(f.length-a,0);h<f.length;++h){var i=f[h][0],j=f[h][1][g];if(j){var k={line:e,weight:j};d[i]?d[i].push(k):d[i]=[k]}}});var e=Object.keys(d).sort();e=e.slice(c(e.length-a,0)),alert(e.map(function(a){return a+': '+d[a].map(function(a){return a.line+' ('+a.weight+')'}).join(', ')}).join('\n'))}),['click','mousedown','mouseup','touchstart','touchend'].forEach(function(a){document.getElementById('findRecentDays').addEventListener(a,function(a){a.stopPropagation()})}),document.getElementById('content').addEventListener('click',function(c){var d=c.target?c.target.tagName.toLowerCase():'';('span'==d||'td'==d)&&(b(),a(c.target,c.clientX,c.clientY))});var d=!1,f=null;document.getElementById('content').addEventListener('touchstart',function(c){var e=c.target?c.target.tagName.toLowerCase():'';'span'!=e&&'td'!=e||1!=c.touches.length||d||(d=!0,f=window.setTimeout(function(){d&&(b(),a(c.target,c.touches[0].clientX,c.touches[0].clientY),d=!1,f=null)},1500))}),document.getElementById('content').addEventListener('touchmove',function(){d&&(d=!1,window.clearTimeout(f),timeout=null)}),document.getElementById('content').addEventListener('touchend',function(b){var c=b.target?b.target.tagName.toLowerCase():'';('span'==c||'td'==c&&1==b.touches.length&&d)&&(b.preventDefault(),a(b.target,b.touches[0].clientX,b.touches[0].clientY),d=!1,window.clearTimeout(f),timeout=null)}),document.getElementById('content').addEventListener('mouseover',function(b){var c=b.target?b.target.tagName.toLowerCase():'';('span'==c||'td'==c)&&a(b.target,b.clientX,b.clientY)})}(function(){function a(){b||(init(),b=!0)}let b=!1;document.onload=a,document.onreadystatechange=function(){'complete'==document.readyState&&a()},document.addEventListener('DOMContentLoaded',a)})();

//# sourceMappingURL=buses.min.js.map