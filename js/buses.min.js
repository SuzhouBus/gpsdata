function createElement(a,b,c){var d=document.createElement(a);appendChildren(d,b);for(const[e,f]of Object.entries(c||{}))if('style'==e&&'object'==typeof f)for(const[a,b]of Object.entries(f||{}))d.style[a]=b;else d.setAttribute('className'==e?'class':e,f);return d}function appendChildren(a,b,c){if(b)return'string'==typeof a&&(a=document.getElementById(a)),'string'==typeof b?a.appendChild(document.createTextNode(b)):(window.Node&&'object'==typeof window.Node?b instanceof window.Node:'object'==typeof b&&'number'==typeof b.nodeType&&'string'==typeof b.nodeName)?a.appendChild(b):b.length&&!c&&[].forEach.call(b,(b)=>appendChildren(a,b,!0)),a}function removeChildren(a){for('string'==typeof a&&(a=document.getElementById(a));a.hasChildNodes();)a.removeChild(a.childNodes[0])}function replaceChildren(a,b){'string'==typeof a&&(a=document.getElementById(a)),removeChildren(a),appendChildren(a,b)}function fillSelect(a,b,c){'string'==typeof a&&(a=document.getElementById(a)),removeChildren(a),b.forEach((b,d)=>{let e=document.createElement('option');e.value=c?c[d]||b:b,e.appendChild(document.createTextNode(b)),a.appendChild(e)})}
class DateUtils{static formatNumber_(a){let b=a.toString();return 1==b.length?'0'+b:b}static formatDate(a,b,c){let d=a.toString();return b&&(d+='-'+DateUtils.formatNumber_(b)),c&&(d+='-'+DateUtils.formatNumber_(c)),d}static toYearMonth(a){let b=a.indexOf('-');if(-1==b)return a;let c=a.indexOf('-',b+1);return-1==c?a:a.substr(0,c)}static nextMonth(a){let b=a.split('-').map((a)=>parseInt(a));return b[1]++,12<b[1]&&(b[0]+=Math.floor(b[1]/12),b[1]%=12),b[2]&&b[2]>DateUtils.daysInMonthsMap_[b[1]]&&(b[2]=DateUtils.daysInMonthsMap_[b[1]]),DateUtils.formatDate.apply(null,b)}static previousMonth(a){let b=a;return'string'==typeof a&&(b=a.split('-').map((a)=>parseInt(a))),b[1]--,0==b[1]&&(b[0]--,b[1]=12),b[2]&&b[2]>DateUtils.daysInMonthsMap_[b[1]]&&(b[2]=DateUtils.daysInMonth(b[1])),DateUtils.formatDate.apply(null,b)}static yesterday(a){let b=a.split('-').map((a)=>parseInt(a));if(b[2]--,0==b[2]){let a=DateUtils.previousMonth(b.slice(0,2)),c=a.split('-').map((a)=>parseInt(a));return a+'-'+DateUtils.formatNumber_(DateUtils.daysInMonth(c[0],c[1]))}return DateUtils.formatDate.apply(null,b)}static isLeapYear(a){return a=parseInt(a),0==a%400||0!=a%100&&0==a%4}static daysInMonth(a,b){return b=parseInt(b),2==b&&DateUtils.isLeapYear(a)?29:DateUtils.daysInMonthsMap_[b]}}DateUtils.daysInMonthsMap_=[void 0,31,28,31,30,31,30,31,31,30,31,30,31];
function wrapIDBRequest(a,b){return new Promise((c,d)=>{if(a.onsuccess=()=>c(a.result),a.onerror=d,b)for(const[c,d]of Object.entries(b))a.addEventListener(c,d)})}class Settings{constructor(a,b){this.component_=a,this.initPromise=window.indexedDB&&'localStorage'!=b?wrapIDBRequest(indexedDB.open(Settings.DB_NAME,2),{upgradeneeded:(a)=>{this.db_=a.target.result,1>a.oldVersion&&this.db_.createObjectStore(Settings.OBJECT_STORE_NAME,{keyPath:['component','key']}),2>a.oldVersion&&a.target.transaction.objectStore(Settings.OBJECT_STORE_NAME).createIndex('component','component',{unique:!1})}}).then((a)=>(this.db_=a,'indexedDB')):window.localStorage?Promise.resolve('localStorage'):Promise.reject('No storage APIs are supported by this browser.')}get(a,b){let c=[],d={},e=!1;if('string'==typeof a||'number'==typeof a||'boolean'==typeof a)c=[a.toString()],e=!0;else if('object'==typeof a&&a instanceof Array)c=a;else if('object'==typeof a)c=Object.keys(a),d=a;else if(a!=void 0)return Promise.reject('Invalid argument.');if(this.db_){let f=this.db_.transaction(Settings.OBJECT_STORE_NAME).objectStore(Settings.OBJECT_STORE_NAME);return 0==c.length?new Promise((a,b)=>{let c=f.index('component').openCursor(this.component_);c.onsuccess=(b)=>{let c=b.target.result;c?(d[c.value.key]=c.value.value,c.continue()):a(d)},c.onerror=b}):Promise.all(c.map((a)=>wrapIDBRequest(f.get([this.component_,a])))).then((f)=>{for(let a=0;a<c.length;++a)void 0===f[a]&&b&&b[c[a]]?d[c[a]]=b[c[a]]:void 0!=f[a]&&(d[c[a]]=f[a].value);return e?d[a]:d})}if(window.localStorage){let f=this.getLocalStorageKeyPrefix_();if(0==c.length)for(let a,b=0;b<localStorage.length;++b)a=localStorage.key(b),a.substr(0,f.length)==f&&c.push(a.substr(f.length));return c.forEach((a)=>{let c=localStorage.getItem(f+a);null===c&&b&&b[a]?d[a]=b[a]:null!==c&&(d[a]=this.deserializeValue_(c))}),e?Promise.resolve(d[a]):Promise.resolve(d)}}set(a,b){let c={};if('string'==typeof a||'number'==typeof a||'boolean'==typeof a)c[a.toString()]=b;else if('object'==typeof a&&a instanceof Array){if(!b||a.length!=b.length)return Promise.reject('Invalid argument. If |key| is an Array, |value| must be an Array with the same length.');for(let d=0;d<a.length;++d)c[a[d]]=b[d]}else if(a&&'object'==typeof a)c=a;else return Promise.reject('Invalid argument.');if(this.db_){let a=this.db_.transaction(Settings.OBJECT_STORE_NAME,'readwrite');return Promise.all(Object.keys(c).map((b)=>wrapIDBRequest(a.objectStore(Settings.OBJECT_STORE_NAME).put({component:this.component_,key:b,value:c[b]}))))}if(window.localStorage){for(const[a,b]of Object.entries(c))localStorage.setItem(this.getLocalStorageKeyPrefix_()+a,this.serializeValue_(b));return Promise.resolve()}}remove(a){let b=[];if('string'==typeof a||'number'==typeof a||'boolean'==typeof a)b=[a.toString()];else if('object'==typeof a&&a instanceof Array)b=a;else return Promise.reject('Invalid argument.');if(this.db_){if(0==b.length)return Promise.resolve();let a=this.db_.transaction(Settings.OBJECT_STORE_NAME,'readwrite'),c=[];return Promise.all(b.map((b)=>wrapIDBRequest(a.objectStore(Settings.OBJECT_STORE_NAME).delete([this.component_,b])).then(()=>c.push(b)))).then(()=>c)}return window.localStorage?(b.forEach((a)=>localStorage.removeItem(a)),Promise.resolve()):void 0}getLocalStorageKeyPrefix_(){return Settings.LOCAL_STORAGE_PREFIX+this.component_+'.'}serializeValue_(a){return JSON.stringify(a)}deserializeValue_(a){return JSON.parse(a)}}Settings.DB_NAME='_settings',Settings.OBJECT_STORE_NAME='_settings',Settings.LOCAL_STORAGE_PREFIX='_settings.';
function _asyncToGenerator(a){return function(){var b=a.apply(this,arguments);return new Promise(function(a,c){function d(e,f){try{var g=b[e](f),h=g.value}catch(a){return void c(a)}return g.done?void a(h):Promise.resolve(h).then(function(a){d('next',a)},function(a){d('throw',a)})}return d('next')})}}class LineDataManager{constructor(a){this.manifest=a,this.loadedLineData_={},this.lineData_={};let b=new Date;b.setMinutes(b.getMinutes()-b.getTimezoneOffset()),this.today_=b.toISOString().substr(0,10),this.earliestDate=Object.keys(a.archives||{}).map((b)=>a.archives[b].start_date).concat([a.start_date]).reduce((a,b)=>b<a?b:a,'9999-99-99'),this.latestDate=this.today_,this.initializeLineNameMap_(a)}initializeLineNameMap_(a){this.lineNameMap_={};let b={};a.sources.forEach((c)=>{this.lineNameMap_[c]={},a.lines[c]&&a.lines[c].forEach((a)=>{if('__+BEGIN_LINES+__'!=a&&'__+END_LINES+__'!=a&&b[a]){let d;for(d=2;b[a+'_'+d];++d);b[a+'_'+d]=!0,this.lineNameMap_[c][a]=a+'_'+d}else b[a]=!0})})}appendLineDataToLoad_(a,b,c){return'string'==typeof c?c=[c]:void 0==c&&(c=this.manifest.sources),Array.prototype.push.apply(a,c.filter((a)=>!this.loadedLineData_[b]||!this.loadedLineData_[b][a]).map((a)=>'current'==b?{month:b,source:a,sizeHint:this.manifest.size_hints[a]}:this.manifest.archives[a]&&this.manifest.archives[a].lengths?{month:b,source:a,lengthTotal:this.manifest.archives[a].lengths[b],lengthAccurate:!0}:{month:b,source:a})),a}isRangeOverlapped_(a,b,c,d){return a<=d&&b>=c}getDataToLoad_(a,b){let c=[];if(this.isRangeOverlapped_(a,b,this.manifest.start_date,this.today_)&&this.appendLineDataToLoad_(c,'current'),a<this.manifest.start_date&&(a<this.earliestDate&&(a=this.earliestDate),b>=this.manifest.start_date&&(b=DateUtils.yesterday(this.manifest.start_date)),a<=b)){let d=Object.keys(this.manifest.archives||{}).map((a)=>{let b=Object.assign({},this.manifest.archives[a],{name:a});return b.start_month=DateUtils.toYearMonth(b.start_date),b.end_month=DateUtils.toYearMonth(b.end_date),b}).filter((c)=>this.isRangeOverlapped_(a,b,c.start_date,c.end_date));for(let e=DateUtils.toYearMonth(a);e<=DateUtils.toYearMonth(b);e=DateUtils.nextMonth(e))this.appendLineDataToLoad_(c,e,d.filter((a)=>e>=a.start_month&&e<=a.end_month).map((a)=>a.name))}return c}load(a,b){var c=this;return _asyncToGenerator(function*(){let d=c.getDataToLoad_(a,b);for(let a of d){let b,e=a.lengthTotal||0,f=!0,g=a.month.replace('-','')+'.json';b='current'==a.month?c.manifest.data[a.source]:c.manifest.archives[a.source].path+g,yield fetch(b).then((()=>{var b=_asyncToGenerator(function*(b){if(window.TextDecoder&&b.body&&b.body.getReader){if(!e){let a=b.headers.get('Content-Encoding'),d=b.headers.get('Content-Length');(!a||'identity'==a)&&d?e=d:'gzip'==a&&d&&(e=d/(c.manifest.gzip_ratio_hint||.5),f=!1)}if(e){a.lengthTotal=e,a.lengthAccurate=f,a.lengthLoaded=0;let g=b.body.getReader(),h=!1,i=new TextDecoder,j='';for(;!h;)yield g.read().then(function(b){b.done&&(h=!0),b.value&&(j+=i.decode(b.value,{stream:b.done}),a.lengthLoaded+=b.value.length,c.onUpdateProgress&&c.onUpdateProgress(d,a))});return JSON.parse(j)}}return b.json()});return function(){return b.apply(this,arguments)}})()).then(function(b){c.loadedLineData_[a.month]||(c.loadedLineData_[a.month]={}),c.loadedLineData_[a.month][a.source]=b,c.importData_(a.month,a.source),a.loaded=!0,c.onUpdateProgress&&c.onUpdateProgress(d,a)}).catch(function(){return a.loaded=!1},Promise.resolve())}return d})()}importData_(a,b){let c=this.loadedLineData_[a][b];Object.keys(c).forEach((d)=>{let e=this.lineNameMap_[b][d]||d;this.lineData_[e]||(this.lineData_[e]={}),this.lineData_[e][a]=c[d]})}isDataLoaded(a,b){return 0==this.getDataToLoad_(a,b).length}getMonthsByRange_(a,b){return Object.keys(this.loadedLineData_).filter((c)=>'current'==c?this.isRangeOverlapped_(a,b,this.manifest.start_date,this.today_):DateUtils.toYearMonth(a)<=c&&DateUtils.toYearMonth(b)>=c)}queryLines(a,b,c){'string'==typeof a&&(a=[a]);let d={},e={};a.forEach((f,g)=>{this.getMonthsByRange_(b,c).sort().forEach((h)=>{let j=this.lineData_[f][h];j&&(j.buses.forEach((a)=>{d[a.licenseId]?d[a.licenseId].busId!=a.busId&&(d[a.licenseId].busId=a.busId):d[a.licenseId]=Object.assign({},a)}),j.details.filter((a)=>a[0]>=b&&a[0]<=c).forEach((b)=>{e[b[0]]||(e[b[0]]={});for(let c,f=0;f<j.buses.length;++f){c=j.buses[f].licenseId,e[b[0]][c]||(e[b[0]][c]=Array(a.length).fill(0));let h=b[1][f];e[b[0]][c][g]=h,0<h&&(d[c].hasWeight=!0)}}))})});let f=this.sortBuses_(Object.keys(d).filter((a)=>d[a].hasWeight).map((a)=>d[a])),g=Array(a.length).fill(0),h=Object.keys(e).sort().map((a)=>[a,f.map((b)=>e[a][b.licenseId]||g)]);return{buses:f,details:h}}containsLines(a){return'string'==typeof a&&(a=[a]),!a.some((a)=>!this.lineData_[a])}queryBuses(a,b,c,d){let e=new Set,f={},g={};(a.lines||Object.keys(this.lineData_)).forEach((h)=>{this.getMonthsByRange_(b,c).sort().forEach((i)=>{let j=this.lineData_[h][i],k=null;j&&j.buses.forEach((i,l)=>{if(this.compareBus_(i,a)){f[i.licenseId]?f[i.licenseId].busId!=i.busId&&(f[i.licenseId].busId=i.busId):f[i.licenseId]=Object.assign({},i),k||(k=j.details.filter((a)=>a[0]>=b&&a[0]<=c));for(let a of k){g[a[0]]||(g[a[0]]={});let b=a[1][l];if(0<b&&(g[a[0]][i.licenseId]||(g[a[0]][i.licenseId]={}),g[a[0]][i.licenseId][h]=b,e.add(h),!d))break}}})})});let h=this.sortLines_(Array.from(e));if(!d)return{lines:h};let i=this.sortBuses_(Object.keys(f).map((a)=>f[a])),j=Object.keys(g).sort().map((a)=>[a,i.map((b)=>h.map((c)=>(g[a][b.licenseId]||{})[c]||0))]);return{lines:h,buses:i,details:j}}compareBus_(a,b){let c=!1;return['busId','licenseId'].forEach((d)=>{b[d]&&(c|=b[d].some((b)=>'string'==typeof b?a[d]==b:b.start&&b.end?a[d]>=b.start&&a[d]<=b.end:b.prefix?a[d].substr(0,b.prefix.length)==b.prefix:b.suffix?a[d].substr(-b.suffix.length)==b.suffix:void 0))}),c}getLines(){return this.sortLines_(Object.keys(this.lineData_))}sortLines_(a){return a.sort((c,d)=>{const e=/^[0-9]+$/,f=/^([A-Z]*)([0-9]*)([A-Z]*)(?:_([0-9]+))?$/;if(this.manifest.line_name_map&&(this.manifest.line_name_map[c]&&(c=this.manifest.line_name_map[c]),this.manifest.line_name_map[d]&&(d=this.manifest.line_name_map[d])),e.test(c)&&e.test(d))return this.compareNumbers_(c,d);c={full:c},d={full:d},[c,d].forEach((a)=>{let b=f.exec(a.full);b&&b[0]?(b[1]&&(a.prefixAlpha=b[1]),b[2]&&(a.numberPart=b[2]),b[3]&&(a.suffixAlpha=b[3]),b[4]&&(a.copyNumber=b[4])):a.other=!0});let g=this.compareWithoutCopyNumber_(c,d);return 0==g?this.compareNumbers_(c.copyNumber||-1,d.copyNumber||-1,'natural'):g})}compareWithoutCopyNumber_(c,a){if(c.other&&a.other)return this.defaultCompare_(c,a);if(c.other&&!a.other)return 1;if(!c.other&&a.other)return-1;if(c.prefixAlpha&&!a.prefixAlpha)return 1;if(!c.prefixAlpha&&a.prefixAlpha)return-1;if(c.numberPart&&!a.numberPart)return-1;if(!c.numberPart&&a.numberPart)return 1;if(c.prefixAlpha&&a.prefixAlpha&&(!c.numberPart&&!a.numberPart||c.prefixAlpha!=a.prefixAlpha))return this.defaultCompare_(c.prefixAlpha,a.prefixAlpha);let b=this.compareNumbers_(c.numberPart,a.numberPart);if(0==b){let b=[void 0].concat(this.manifest.line_name_suffix_order||[]);return[c.suffixAlpha,a.suffixAlpha].sort().forEach((a)=>!b.includes(a)&&b.push(a)),this.defaultCompare_(b.indexOf(c.suffixAlpha),b.indexOf(a.suffixAlpha))}return b}compareNumbers_(c,d,e){let f='plain'==(e||this.linesSortOrder);return f&&('number'==!typeof c||'number'==!typeof d)?(c=c.toString(),d=d.toString()):!f&&('string'==typeof c||'string'==typeof d)&&(c=parseInt(c),d=parseInt(d)),this.defaultCompare_(c,d)}defaultCompare_(c,a){return c<a?-1:c>a?1:0}sortBuses_(a){return a.sort((c,a)=>{if(c.busId&&a.busId)return c.busId<a.busId?-1:c.busId>a.busId?1:0;return c.busId&&!a.busId?-1:!c.busId&&a.busId?1:c.licenseId<a.licenseId?-1:c.licenseId>a.licenseId?1:0})}}const COLOR=[95,140,181],COLOR_GREY=[160,160,160],PALETTE=[[230,25,75],[60,180,75],[255,225,25],[0,130,200],[245,130,48],[145,30,180],[70,240,240],[240,50,230],[210,245,60],[250,190,190],[0,128,128],[170,110,40],[128,0,0],[170,255,195],[128,128,0],[0,0,128]],NBSP='\xA0';let currentStartDate,currentEndDate,lineDataManager=new LineDataManager(manifest),settings=new Settings('buses'),progressText='',activeLines=[];(function(){var a=new Date;a.setMinutes(a.getMinutes()-a.getTimezoneOffset()),currentEndDate=a.toISOString().substr(0,10),a.setDate(a.getDate()-30+1),currentStartDate=a.toISOString().substr(0,10)})();function loadRemoteManifest(){fetch('manifest.json',{cache:'no-cache'}).then((a)=>a.json()).then((a)=>{document.getElementById('last_update_container').style.display='',appendChildren('last_update_time',a.last_update_time)}).catch(()=>{document.getElementById('offline_prompt').style.display=''})}function isBusIdContinuous(c,a){if(c.substr(0,2)!=a.substr(0,2))return!1;var b=parseInt(c.substr(2)),d=parseInt(a.substr(2));if(b==d+1||d==b+1)return!0;return!('5-'!=c.substr(0,2)||(3!=b%10||b+2!=d)&&(3!=d%10||d+2!=b))}function convertLineName(a,b){if(b.line_name_map&&b.line_name_map[a])return convertLineName(b.line_name_map[a],b);let c=/^([^0-9]*)([0-9]+)([^0-9_]*)(.*)$/.exec(a);if(c){if(c[1]&&b.line_name_prefix_map&&b.line_name_prefix_map[c[1]]){let a=b.line_name_prefix_map[c[1]];'string'==typeof a?c[1]=a:(c[1]=a[0],c[2]+=a[1])}return c[3]&&b.line_name_suffix_map&&b.line_name_suffix_map[c[3]]&&(c[3]='\uFF08'+b.line_name_suffix_map[c[3]]+'\uFF09'),c[1]+c[2]+c[3]+c[4]}return a}function updateLineChooser(a,b){const c=/^([^0-9]*[0-9]+)([^_]*)(.*)$/;let d=[],e=[],f=null;for(let g,h=0;h<a.length;++h)g=c.exec(a[h]),f&&g&&f[1]==g[1]&&f[3]==g[3]&&!(b.unrelated_lines||[]).includes(g[1]+g[2])?(d[d.length-1]=convertLineName(g[1]+g[3],b),e[d.length-1]+='+'+a[h]):(d.push(convertLineName(a[h],b)),e.push(a[h])),f=g;fillSelect('lineChooser',d,e)}function createTableHeader(a){let b=a.map((a)=>createElement('th',a.busId)),c=0,d=!1,e='';for(let f=!1;c<a.length;++c)e=f?'busid_odd_range_element':'busid_even_range_element',0<c&&isBusIdContinuous(a[c-1].busId,a[c].busId)?d?b[c-1].className=e:(b[c-1].className='busid_range_begin '+e,d=!0):d&&(d=!1,b[c-1].className='busid_range_end '+e,f=!f);return d&&(b[c-1].className='busid_range_end '+e),createElement('thead',[createElement('tr',[createElement('th','\u81EA\u7F16\u53F7'),...b]),createElement('tr',['\u8F66\u724C\u53F7'].concat(a.map((a)=>a.licenseId)).map((a)=>createElement('th',a)))])}function convertBusQuery(a){const b=/^([0-9])(?:0|-)([0-9]{4})$/,c=/^([0-9])(?:0|-)([0-9]{4})(?:~|～)([0-9])(?:0|-)([0-9]{4})$/,d=/^(?:苏\s*E[^0-9A-Z]{0,4})?([0-9A-Z]{5}|[0-9]{5}(?:D|F))$/i,e=/^(?:苏\s*E[^0-9A-Z]{0,4})?([0-9A-Z]{5}|[0-9]{5}(?:D|F))(?:~|～)(?:苏\s*E[^0-9A-Z]{0,4})?([0-9A-Z]{5}|[0-9]{5}(?:D|F))$/i,f=/^([^~～*?#]+)(?:\*|\?|#){1,3}$/;let g={busId:[],licenseId:[]},h=a.split(/,|;|，|；|、|\s+/);return h.forEach((a)=>{let h=null;(h=c.exec(a))?g.busId.push({start:h[1]+'-'+h[2],end:h[3]+'-'+h[4]}):(h=e.exec(a))?g.licenseId.push({start:h[1].toUpperCase(),end:h[2].toUpperCase()}):(h=f.exec(a))?h[1].includes('-')?g.busId.push({prefix:h[1]}):g.licenseId.push({prefix:h[1].toUpperCase()}):(h=b.exec(a))?g.busId.push(h[1]+'-'+h[2]):(h=d.exec(a))?g.licenseId.push(h[1].toUpperCase()):'*'==a[0]&&g.licenseId.push({suffix:a.substr(1)})}),g}function findBusByQuery(a){let b=document.getElementById('bus_count_container'),c=document.getElementById('bus_count'),d=lineDataManager.queryBuses(convertBusQuery(a),currentStartDate,currentEndDate,!0);fillSelect(document.getElementById('resultList'),d.lines),0<d.lines.length?(c.innerText=d.buses.length,b.style.display=''):b.style.display='none'}function showLinesNew(a,b,c){if('string'==typeof a&&(a=[a]),a.length>PALETTE.length&&!c)return void replaceChildren('content','\u60A8\u9009\u62E9\u7684\u7EBF\u8DEF\u592A\u591A\u4E86\uFF01');if(!b&&!lineDataManager.containsLines(a))return void replaceChildren('content','\u67D0\u4E9B\u7EBF\u8DEF\u4E0D\u5B58\u5728\uFF01');removeChildren('legend'),1<a.length&&appendChildren('legend',a.map((a,b)=>createElement('span',[createElement('span',null,{style:{backgroundColor:'rgb('+PALETTE[b%PALETTE.length].join(',')+')',height:'1em',width:'2em',display:'inline-block',marginLeft:'3em'}}),' '+convertLineName(a,manifest)])));let d=b||lineDataManager.queryLines(a,currentStartDate,currentEndDate);replaceChildren('content',createElement('table',[createTableHeader(d.buses),createElement('tbody',d.details.map((b)=>createElement('tr',[createElement('th',b[0]),...d.buses.map((d,e)=>{let f=b[1][e].filter((a)=>0<a).length;if(0==f)return createElement('td',c?[createElement('span',NBSP,{className:'line_view_bus_item',style:{width:'100%',backgroundColor:'rgb('+COLOR_GREY.join(',')+')'}})]:null);let g=createElement('td'),h=!0;return b[1][e].forEach((b,d)=>{if(0<b){let e=a[d];h?h=!1:e='/'+e,g.appendChild(createElement('span',c?e:NBSP,{className:'line_view_bus_item',style:Object.assign({width:100/f+'%',backgroundColor:c?'rgb('+COLOR_GREY.map((a)=>parseInt((255-a)*b+a)).join(',')+')':'rgb('+(1==a.length?COLOR:PALETTE[d]).map((a)=>parseInt((255-a)*(1-b)+a)).join(',')+')'},c?{color:'rgb('+PALETTE[d%PALETTE.length],fontWeight:'bold'}:null),"data-line":a[d]}))}}),g})])))]))}function onChooseLine(){let a=this.value.split('+'),b=!1;document.getElementById('compare').checked?a.forEach((a)=>!activeLines.includes(a)&&(activeLines.push(a),b=!0)):(activeLines=a,b=!0),b&&(showLinesNew(activeLines),history.pushState(1==activeLines.length?activeLines[0]:activeLines,'','#'+activeLines.join('+')))}function parseUrlHash(){if(location.hash.replace('#','')){var a=location.hash.replace('#','');return activeLines=a.split('+'),lineChooser.value=a,showLinesNew(activeLines),!0}}function onModifyDate(){let a=document.getElementById('startDate'),b=document.getElementById('endDate');if(a.value<lineDataManager.earliestDate&&(a.value=lineDataManager.earliestDate),b.value>lineDataManager.latestDate&&(b.value=lineDataManager.latestDate),currentStartDate==a.value&&currentEndDate==b.value)a.value=currentStartDate,b.value=currentEndDate;else if(currentStartDate=a.value,currentEndDate=b.value,lineDataManager.isDataLoaded(currentStartDate,currentEndDate))showLinesNew(activeLines);else{let a=document.getElementById('progress');document.getElementById('progressbar').style.width=0,document.getElementById('progress_text').innerText=progressText,a.style.display='',lineDataManager.load(currentStartDate,currentEndDate).then(()=>{a.style.display='none',updateLineChooser(lineDataManager.getLines(),lineDataManager.manifest),showLinesNew(activeLines)})}}function navigateLine(a,b){let c=document.getElementById('lineChooser'),d=Math.max(0,c.selectedIndex+a);0<c.children.length&&d>c.children.length-1&&(d=c.children.length-1),c.selectedIndex=d,b||onChooseLine.call(c)}function init(){function a(a,b,d){var e=document.getElementById('cellDetails');if('none'!=e.style.display){var f=document.getElementById('cellLineContainer'),g=a;'span'==g.tagName.toLowerCase()?(g=g.parentElement,f.style.display='',document.getElementById('cellLine').innerText=a.getAttribute('data-line')):f.style.display='none',document.getElementById('cellDate').innerText=g.parentElement.children[0].innerText;var h=document.getElementById('content').querySelector('table thead');document.getElementById('cellBusId').innerText=h.children[0].children[g.cellIndex].innerText,document.getElementById('cellLicenseId').innerText=h.children[1].children[g.cellIndex].innerText,e.style.left=c(b,window.innerWidth&&e.clientWidth?window.innerWidth-e.clientWidth-30:b)+document.body.scrollLeft+document.documentElement.scrollLeft+8+'px',e.style.top=c(d,window.innerHeight&&e.clientHeight?window.innerHeight-e.clientHeight-30:d)+document.body.scrollTop+document.documentElement.scrollTop+8+'px'}}function b(){var a=document.getElementById('cellDetails');a.style.display='none'!=a.style.display||document.getElementById('disableInfotip').checked?'none':''}var c=Math.min;let d=document.getElementById('lineChooser'),e=document.getElementById('startDate'),f=document.getElementById('endDate');progressText=document.getElementById('progress_text').innerText,lineDataManager.onUpdateProgress=function(a){let b=document.getElementById('progressbar'),d=a.filter((a)=>a.sizeHint),e=d.reduce((a,b)=>a+=b.sizeHint,0),f=d.reduce((a,b)=>{let d=b.sizeHint/e;return b.loaded?a+=d:b.lengthLoaded&&b.lengthTotal&&(b.lengthAccurate?a+=d*b.lengthLoaded/b.lengthTotal:a+=d*c(b.lengthLoaded,.95*b.lengthTotal)/b.lengthTotal),a},0),g=a.filter((a)=>a.lengthAccurate&&!a.sizeHint),h=g.reduce((a,b)=>a+b.lengthTotal,0),i=g.reduce((a,b)=>{let c=b.lengthTotal/h;return b.loaded?a+=c:b.lengthLoaded&&(a+=c*b.lengthLoaded/b.lengthTotal),a},0),j=100*(f*d.length/a.length+i*g.length/a.length);b.style.width=j+'%',document.getElementById('progress_text').innerText=progressText+Math.round(j)+'%'},lineDataManager.load(currentStartDate,currentEndDate).then(()=>{document.getElementById('progress').style.display='none',updateLineChooser(lineDataManager.getLines(),lineDataManager.manifest),parseUrlHash()||(activeLines=[d.children[0].value],showLinesNew(activeLines)),loadRemoteManifest()}),e.value=currentStartDate,f.value=currentEndDate,e.addEventListener('change',onModifyDate),f.addEventListener('change',onModifyDate),d.addEventListener('change',onChooseLine),document.getElementById('resultList').addEventListener('change',onChooseLine),window.onpopstate=function(a){a.state instanceof Array?(activeLines=a.state,showLinesNew(activeLines)):a.state?(activeLines=[a.state],showLinesNew(a.state)):parseUrlHash()},document.getElementById('bus_query').addEventListener('input',function(){findBusByQuery(this.value)}),document.getElementById('findDetails').addEventListener('click',function(){let a=lineDataManager.queryBuses(Object.assign({lines:[].map.call(document.getElementById('resultList').children,(a)=>a.value)},convertBusQuery(document.getElementById('bus_query').value)),currentStartDate,currentEndDate,!0);showLinesNew(a.lines,a,!0)}),document.getElementById('content').addEventListener('click',function(c){var d=c.target?c.target.tagName.toLowerCase():'';('span'==d||'td'==d)&&(b(),a(c.target,c.clientX,c.clientY))});var g=!1,h=null;document.getElementById('content').addEventListener('touchstart',function(c){var d=c.target?c.target.tagName.toLowerCase():'';'span'!=d&&'td'!=d||1!=c.touches.length||g||(g=!0,h=window.setTimeout(function(){g&&(b(),a(c.target,c.touches[0].clientX,c.touches[0].clientY),g=!1,h=null)},1500))}),document.getElementById('content').addEventListener('touchmove',function(){g&&(g=!1,window.clearTimeout(h),h=null)}),document.getElementById('content').addEventListener('touchend',function(b){var c=b.target?b.target.tagName.toLowerCase():'';('span'==c||'td'==c&&1==b.touches.length&&g)&&(b.preventDefault(),a(b.target,b.touches[0].clientX,b.touches[0].clientY),g=!1,window.clearTimeout(h),h=null)}),document.getElementById('content').addEventListener('mouseover',function(b){var c=b.target?b.target.tagName.toLowerCase():'';('span'==c||'td'==c)&&a(b.target,b.clientX,b.clientY)});let i=!1;return document.addEventListener('keydown',function(a){(a.altKey||a.ctrlKey||a.shiftKey||a.metaKey)&&(('ArrowUp'==a.key||38==a.keyCode)&&0<d.selectedIndex?(navigateLine(-1,a.repeat),i=a.repeat,a.preventDefault()):('ArrowDown'==a.key||40==a.keyCode)&&d.selectedIndex<d.children.length-1&&(navigateLine(1,a.repeat),i=a.repeat,a.preventDefault()))}),document.addEventListener('keyup',function(){i&&(i=!1,navigateLine(0,!1))}),settings.initPromise.then(()=>{let a=document.getElementById('disableInfotip');return a.addEventListener('change',()=>{settings.set({disableInfotip:a.checked})}),settings.get({disableInfotip:!1}).then((b)=>{a.checked=!!b.disableInfotip})})}(function(){function a(){b||(init(),b=!0)}let b=!1;document.onload=a,document.onreadystatechange=function(){'complete'==document.readyState&&a()},document.addEventListener('DOMContentLoaded',a)})();

//# sourceMappingURL=buses.min.js.map