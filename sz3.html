<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Buses</title>
    <script data-feature-detection>
      var legacy = !window.Promise || !window.fetch || !String.prototype.includes || !Array.prototype.includes;
      try {
        Function('class test{async t(){let e=x=>x;const s=0;await 0;}}');
      } catch(e) {
        legacy = true;
      }
      if (legacy) {
        location.replace('sz3.legacy.html');
      }
    </script>
    
    
    
    
    
    
    <script>
      var manifest = (
// BEGIN MANIFEST
{
  "sources": ["sz3", "sz4", "wj"],
  "last_update_time": "2018-03-26 22:30:01",
  "data": {
    "sz3": "sz3.json",
    "sz4": "sz4.json",
    "wj": "wj.json"
  },
  "size_hints": {
    "sz3": 389,
    "sz4": 316,
    "wj": 5.9
  },
  "start_date": "2018-01-01",
  "lines": {
    "sz3": ["__+BEGIN_LINES+__","1001","100","101","102","102N","108","109","10N","10S","112","118","119","126","142","146","161","166","169","170N","170S","175","178","179","190","190N","190S","19","1","200","200N","200S","202","204","209","218","219","261","262","26","27","27D","2SIP","2SND","3002","301","304","304L","305","307","308","311","311L","312","313","315","317","318","31","321","324","325","32","32Q","331","33","34","34LN","34N","35","360","36","38","406","40E","40W","415","42","441","446","44","45","47","4","501","502","502D","511","513","514","518","521","522","523","526","529","52","53","552","553","557","558","563","56","585","5","602","60","60N","60S","621","622","62","64","65","663","66","67","698","69","69Q","7","810","810E","810W","811","812","813","814","815","816","817","818","819","81","827","82","84","85","865","866","86","871","872","873","875","876","877","878","879","87","89","8","9001","9002","9003","9004","9005","9006","9007","9008","9009","900","900N","900S","9011","902","921","922","923","925","926","928","931","932","933","935","937","949","970","970E","970W","980","980E","980W","9","G10","G11","G12","G2N","G2S","G8","J3","K1","K6","K7","N1","N2","N3","N5","XT","Y1","Y1N","Y1S","Y2","Y3","Y4","Y4L","Y5","Y5N","Y5S","__+END_LINES+__"],
    "sz4": ["__+BEGIN_LINES+__","1001E","1001W","100N","100S","106","106Q","110N","110S","111","116","120E","120W","127","129","132","136","141","150N","150S","152","156","158","162","16","175","176","180N","180S","182","185","206","207","215","238","28","3002","300N","300S","302","303","306","309","316","319","322","326","328","329","332","333","335","336","336Q","338","356","357","360","37","39","3","400E","400W","43","442","443","445","5005","503","504","505","508","509","512","518","51","528","54","557","55","560","58","59","611","612","615","623","627","628","63","691","692","6","801","802","803","804","805","805Q","806","807","808","809","80","80N","80S","810E","810W","811","812","813","814","815","816","817","818","819","81","820","820E","820W","821","822","823","824","825","826","828","82","831","832","833","835","836","837","839","83","84","851","852","853","854","855","856","85","85D","861","862","863","864","865","866","86","871","872","873","875","876","877","878","879","87","881","882","883","88","89","9001","9002","9002E","9002W","9003","9004","9005","9005E","9005W","9006","9007","9008","9009","9010","9011","9012","9013","9026","922","925","928","G6","G7","JLJ","K3","K5","K8","K8Z","N10","N4","N6","N7","N8","N9","SP","SZL","__+END_LINES+__"]
  },
  "archives": {
    "sz3": {
      "path": "archive/sz3/",
      "start_date": "2016-11-23",
      "end_date": "2018-02-28"
    },
    "sz4": {
      "path": "archive/sz4/",
      "start_date": "2017-04-15",
      "end_date": "2018-02-28"
    }
  }
}
// END MANIFEST
      );
    </script>
    <style>
      body {
        font-size: 12pt;
      }

      #cellDetails {
        position: absolute;
        border: black solid 2px;
        padding: 8px;
        background-color: #f0e5a6;
        white-space: nowrap;
      }

      #progress {
        margin-left: 3em;
        margin-right: 3em;
        border: black 3px solid;
      }

      #progressbar {
        background-color: #0000ff;
        height: 1.2em;
        width: 0;
        text-align: center;
      }

      #offline_prompt {
        background-color: #ff9999;
        border: red 4px solid;
        text-align: center;
        font-weight: bold;
      }

      #content table {
        border-spacing: 0;
      }

      #content th {
        white-space: nowrap;
        margin-left: 0.3ex;
        margin-right: 0.3ex;
      }

      .busid_range_begin {
      }

      .busid_odd_range_element {
        background-color: #f0f080;
      }

      .busid_even_range_element {
        background-color: #c8f9f9;
      }

      .busid_range_end {
      }
    </style>
    <script>function _asyncToGenerator(a){return function(){var b=a.apply(this,arguments);return new Promise(function(a,c){function d(e,f){try{var g=b[e](f),h=g.value}catch(a){return void c(a)}return g.done?void a(h):Promise.resolve(h).then(function(a){d('next',a)},function(a){d('throw',a)})}return d('next')})}}class DateUtils{static formatNumber_(a){let b=a.toString();return 1==b.length?'0'+b:b}static formatDate(a,b,c){let d=a.toString();return b&&(d+='-'+DateUtils.formatNumber_(b)),c&&(d+='-'+DateUtils.formatNumber_(c)),d}static toYearMonth(a){let b=a.indexOf('-');if(-1==b)return a;let c=a.indexOf('-',b+1);return-1==c?a:a.substr(0,c)}static nextMonth(a){let b=a.split('-');return b[1]++,12<b[1]&&(b[0]+=b[1]/12,b[1]%=12),b[2]&&b[2]>DateUtils.daysInMonthsMap_[b[1]]&&(b[2]=DateUtils.daysInMonthsMap_[b[1]]),DateUtils.formatDate.apply(null,b)}static previousMonth(a){let b=a;return'string'==typeof a&&(b=a.split('-')),b[1]--,0==b[1]&&(b[0]--,b[1]=12),b[2]&&b[2]>DateUtils.daysInMonthsMap_[b[1]]&&(b[2]=DateUtils.daysInMonth(b[1])),DateUtils.formatDate.apply(null,b)}static yesterday(a){let b=a.split('-');if(b[2]--,0==b[2]){let a=DateUtils.previousMonth(b.slice(0,2)),c=a.split('-');return a+'-'+DateUtils.formatNumber_(DateUtils.daysInMonth(c[0],c[1]))}}static isLeapYear(a){return a=parseInt(a),0==a%400||0!=a%100&&0==a%4}static daysInMonth(a,b){return b=parseInt(b),2==b&&isLeapYear(a)?29:DateUtils.daysInMonthsMap_[b]}}DateUtils.daysInMonthsMap_=[void 0,31,28,31,30,31,30,31,31,30,31,30,31];class LineDataManager{constructor(a){this.manifest=a,this.loadedLineData_={},this.lineData_={};let b=new Date;b.setMinutes(b.getMinutes()-b.getTimezoneOffset()),this.today_=b.toISOString().substr(0,10),this.earliestDate=Object.keys(a.archives||{}).map((b)=>a.archives[b].start_date).concat([a.start_date]).reduce((a,b)=>b<a?b:a,'9999-99-99'),this.initializeLineNameMap_(a)}initializeLineNameMap_(a){this.lineNameMap_={};let b={};a.sources.forEach((c)=>{this.lineNameMap_[c]={},a.lines[c]&&a.lines[c].forEach((a)=>{if('__+BEGIN_LINES+__'!=a&&'__+END_LINES+__'!=a&&b[a]){let d;for(d=2;b[a+'_'+d];++d);b[a+'_'+d]=!0,this.lineNameMap_[c][a]=a+'_'+d}else b[a]=!0})})}appendLineDataToLoad_(a,b,c){return'string'==typeof c?c=[c]:void 0==c&&(c=this.manifest.sources),Array.prototype.push.apply(a,c.filter((a)=>!this.loadedLineData_[b]||!this.loadedLineData_[b][a]).map((a)=>({month:b,source:a}))),a}isRangeOverlapped_(a,b,c,d){return a<=d&&b>=c}getDataToLoad_(a,b){let c=[];if(this.isRangeOverlapped_(a,b,this.manifest.start_date,this.today_)&&this.appendLineDataToLoad_(c,'current'),a<this.manifest.start_date&&(a<this.earliestDate&&(a=this.earliestDate),b>=this.manifest.start_date&&(b=DateUtils.yesterday(this.manifest.start_date)),a<=b)){let d=DateUtils.toYearMonth(a),e=DateUtils.toYearMonth(b),f=Object.keys(this.manifest.archives||{}).map((a)=>{let b=Object.assign({},this.manifest.archives[a],{name:a});return b.start_month=DateUtils.toYearMonth(b.start_date),b.end_month=DateUtils.toYearMonth(b.end_date),b}).filter((c)=>this.isRangeOverlapped_(a,b,c.start_date,c.end_date));for(let d=DateUtils.toYearMonth(a);d<=DateUtils.toYearMonth(b);d=DateUtils.nextMonth(d))this.appendLineDataToLoad_(c,d,f.filter((a)=>d>=a.start_month&&d<=a.end_month).map((a)=>a.name))}return c}load(a,b){var c=this;return _asyncToGenerator(function*(){let d=c.getDataToLoad_(a,b);for(let a of d){let b;b='current'==a.month?c.manifest.data[a.source]:c.manifest.archives[a.source].path+a.month.replace('-','')+'.json',yield fetch(b).then(function(a){return a.json()}).then(function(b){c.loadedLineData_[a.month]||(c.loadedLineData_[a.month]={}),c.loadedLineData_[a.month][a.source]=b,c.importData_(a.month,a.source),a.loaded=!0,c.onUpdateProgress&&c.onUpdateProgress(d,a.month,a.source,1,1)}).catch(function(){return a.loaded=!1},Promise.resolve())}return d})()}importData_(a,b){let c=this.loadedLineData_[a][b];Object.keys(c).forEach((d)=>{let e=this.lineNameMap_[b][d]||d;this.lineData_[e]||(this.lineData_[e]={}),this.lineData_[e][a]=c[d]})}isDataLoaded(a,b){return 0==this.getDataToLoad_(a,b).length}getMonthsByRange_(a,b){return Object.keys(this.loadedLineData_).filter((c)=>'current'==c?this.isRangeOverlapped_(a,b,this.manifest.start_date,this.today_):DateUtils.toYearMonth(a)<=c&&DateUtils.toYearMonth(b)>=c)}queryLines(a,b,c){'string'==typeof a&&(a=[a]);let d={},e={};a.forEach((f,g)=>{this.getMonthsByRange_(b,c).sort().forEach((h)=>{let j=this.lineData_[f][h];j&&(j.buses.forEach((a)=>{d[a.licenseId]?d[a.licenseId].busId!=a.busId&&(d[a.licenseId].busId=a.busId):d[a.licenseId]=Object.assign({},a)}),j.details.filter((a)=>a[0]>=b&&a[0]<=c).forEach((b)=>{e[b[0]]||(e[b[0]]={});for(let c,f=0;f<j.buses.length;++f){c=j.buses[f].licenseId,e[b[0]][c]||(e[b[0]][c]=Array(a.length).fill(0));let h=b[1][f];e[b[0]][c][g]=h,0<h&&(d[c].hasWeight=!0)}}))})});let f=this.sortBuses_(Object.keys(d).filter((a)=>d[a].hasWeight).map((a)=>d[a])),g=Array(a.length).fill(0),h=Object.keys(e).sort().map((a)=>[a,f.map((b)=>e[a][b.licenseId]||g)]);return{buses:f,details:h}}containsLines(a){return'string'==typeof a&&(a=[a]),!a.some((a)=>!this.lineData_[a])}queryBuses(a,b,c,d){let e=new Set,f={},g={};(a.lines||Object.keys(this.lineData_)).forEach((h)=>{this.getMonthsByRange_(b,c).sort().forEach((i)=>{let j=this.lineData_[h][i],k=null;j&&j.buses.forEach((i,l)=>{if(this.compareBus_(i,a)){f[i.licenseId]?f[i.licenseId].busId!=i.busId&&(f[i.licenseId].busId=i.busId):f[i.licenseId]=Object.assign({},i),k||(k=j.details.filter((a)=>a[0]>=b&&a[0]<=c));for(let a of k){g[a[0]]||(g[a[0]]={});let b=a[1][l];if(0<b&&(g[a[0]][i.licenseId]||(g[a[0]][i.licenseId]={}),g[a[0]][i.licenseId][h]=b,e.add(h),!d))break}}})})});let h=this.sortLines_(Array.from(e));if(!d)return{lines:h};let i=this.sortBuses_(Object.keys(f).map((a)=>f[a])),j=Object.keys(g).sort().map((a)=>[a,i.map((b)=>h.map((c)=>(g[a][b.licenseId]||{})[c]||0))]);return{lines:h,buses:i,details:j}}compareBus_(a,b){let c=!1;return['busId','licenseId'].forEach((d)=>{b[d]&&(c|=b[d].some((b)=>'string'==typeof b?a[d]==b:b.start&&b.end?a[d]>=b.start&&a[d]<=b.end:b.prefix?a[d].substr(0,b.prefix.length)==b.prefix:void 0))}),c}getLines(){return this.sortLines_(Object.keys(this.lineData_))}sortLines_(a){let c='plain'==this.linesSortOrder;return a.sort((d,a)=>{let b,e=parseInt(d),f=parseInt(a);return b=d<a?-1:d>a?1:0,c?b:isNaN(e)&&isNaN(f)?b:isNaN(e)&&!isNaN(f)?1:!isNaN(e)&&isNaN(f)?-1:e<f?-1:e>f?1:b})}sortBuses_(a){return a.sort((c,a)=>{if(c.busId&&a.busId)return c.busId<a.busId?-1:c.busId>a.busId?1:0;return c.busId&&!a.busId?-1:!c.busId&&a.busId?1:c.licenseId<a.licenseId?-1:c.licenseId>a.licenseId?1:0})}isDateRangeValid(a,b){return a>=this.earliestDate&&b<=this.today_}}const COLOR=[106,90,205],COLOR_GREY=[160,160,160],PALETTE=[[230,25,75],[60,180,75],[255,225,25],[0,130,200],[245,130,48],[145,30,180],[70,240,240],[240,50,230],[210,245,60],[250,190,190],[0,128,128],[170,110,40],[128,0,0],[170,255,195],[128,128,0],[0,0,128]];let currentStartDate,currentEndDate,lineDataManager=new LineDataManager(manifest),activeLines=[];var lineData={},lineNameMap={};(function(){var a=new Date;a.setMinutes(a.getMinutes()-a.getTimezoneOffset()),currentEndDate=a.toISOString().substr(0,10);a.getMonth();a.setDate(a.getDate()-30+1),currentStartDate=a.toISOString().substr(0,10)})();function loadData(){function a(a,b,d){var e=c[a].total;if(c[a].total=d,c[a].loaded=b,e!=d){var f=1,g=0;for(var h in c)0==c[h].total?f-=c[h].weight:g+=c[h].total;for(var h in c)0!=c[h].total&&(c[h].weight=f*c[h].total/g)}var i=0;for(var h in c)0!=c[h].total&&(i+=c[h].loaded/c[h].total*c[h].weight);1<i&&(i=1),isNaN(i)&&(i=0),document.getElementById('progressbar').style.width=100*i+'%',document.getElementById('progressbar').innerText='Loading...'+Math.round(100*i)+'%'}var b={};manifest.sources.forEach(function(a){lineNameMap[a]={},manifest.lines[a]&&manifest.lines[a].forEach(function(c){if('__+BEGIN_LINES+__'!=c&&'__+END_LINES+__'!=c&&b[c]){var d;for(d=2;b[c+'_'+d];++d);b[c+'_'+d]=!0,lineNameMap[a][c]=c+'_'+d}else b[c]=!0})});var c={};if(manifest.sources.forEach(function(a){c[a]={total:0,loaded:0,weight:1/manifest.sources.length}}),manifest.size_hints){var d=0;for(var e in manifest.size_hints)manifest.size_hints[e]?d+=manifest.size_hints[e]:remainingProgress-=1/manifest.sources.length;for(var e in manifest.size_hints)manifest.size_hints[e]&&(c[e].weight=1*manifest.size_hints[e]/d)}Promise.all(manifest.sources.map(function(b){return new Promise(function(c){var d=manifest.data[b],e=new XMLHttpRequest;e.open('GET',d,!0),e.onreadystatechange=function(){if(4==e.readyState&&200==e.status){var d=e.responseText;-1!=d.indexOf('__BUS_LINE_DATA')&&(d=d.replace(/var __BUS_LINE_DATA=JSON\.parse\('|\\\n|'\)$/g,''));var f=JSON.parse(d);for(var g in f){var h=g;lineNameMap[b]&&lineNameMap[b][g]&&(h=lineNameMap[b][g]);var j=f[g];if(lineData[h]){console.warn('New line name conflict!');var k;for(k=2;lineData[h+'_'+k];++k);lineData[h+'_'+k]=j}else lineData[h]=j}a(b,1,1),c()}else 4==e.readyState&&c()},e.onprogress=function(c){c.lengthComputable&&a(b,c.loaded,c.total)},e.send()})})).then(function(){document.getElementById('progress').style.display='none',updateLineChooser(lineDataManager.getLines()),parseUrlHash()||showLinesNew(lineChooser.children[0].value),loadRemoteManifest()})}function loadRemoteManifest(){fetch('manifest.json',{cache:'no-cache'}).then((a)=>a.json()).then((a)=>{document.getElementById('last_update_container').style.display='',document.getElementById('last_update_time').appendChild(document.createTextNode(a.last_update_time))}).catch(()=>{document.getElementById('offline_prompt').style.display=''})}function isBusIdContinuous(c,a){if(c.substr(0,2)!=a.substr(0,2))return!1;var b=parseInt(c.substr(2)),d=parseInt(a.substr(2));if(b==d+1||d==b+1)return!0;return!('5-'!=c.substr(0,2)||(3!=b%10||b+2!=d)&&(3!=d%10||d+2!=b))}function updateLineChooser(a){var b=document.getElementById('lineChooser');a.forEach((a)=>{let c=document.createElement('option');c.value=a,c.appendChild(document.createTextNode(a)),b.appendChild(c)})}function fillTr(a,b,c){var d=document.createElement('tr');return Array.prototype.forEach.call(a,function(a,e){var f=document.createElement(b?'th':'td');if(c&&c[e])for(var g in c[e])f.setAttribute(g,c[e][g]);f.appendChild(document.createTextNode(a)),d.appendChild(f)}),d}function removeChildren(a){for(;a.hasChildNodes();)a.removeChild(a.childNodes[0])}function createTableHeader(a){var b=document.createElement('thead'),c=document.createElement('tr'),d=document.createElement('th');d.appendChild(document.createTextNode('Bus ID')),c.appendChild(d);for(var e,f=null,g=!1,h=!1,j='',k=0;k<a.length;++k)e=document.createElement('th'),e.appendChild(document.createTextNode(a[k].busId)),c.appendChild(e),j=h?'busid_odd_range_element':'busid_even_range_element',0<k&&isBusIdContinuous(a[k-1].busId,a[k].busId)?g?f.className=j:(f.className='busid_range_begin '+j,g=!0):g&&(g=!1,f.className='busid_range_end '+j,h=!h),f=e;return g&&(f.className='busid_range_end '+j),b.appendChild(c),b.appendChild(fillTr(['License ID'].concat(a.map((a)=>a.licenseId)),!0)),b}function getFilteredLineData(a){if('string'==typeof a){var b=lineData[a].details.filter((a)=>a[0]>=currentStartDate&&a[0]<=currentEndDate).slice(),c=lineData[a].buses,d=Array(c.length).fill(0);b.forEach((a)=>a[1].forEach((a,b)=>d[b]+=a));var e=(a,b)=>0<d[b];return{buses:c.filter(e),details:b.map((a)=>[a[0],a[1].filter(e)])}}console.error('Not implemented')}function showLine(a){var b=document.getElementById('content');if(removeChildren(b),!lineData[a])return void b.appendChild(document.createTextNode('Line '+a+' does not exist!'));var c=getFilteredLineData(a),d=document.createElement('table');d.appendChild(createTableHeader(c.buses));var e=document.createElement('tbody');c.details.forEach(function(a){e.appendChild(fillTr([a[0]].concat(Array(a[1].length).fill('')),!1,[''].concat(a[1].map(function(a){return{style:'background-color:rgb('+COLOR.map(function(b){return parseInt((255-b)*(1-a)+b)}).join(',')+')'}}))))}),d.appendChild(e),b.appendChild(d)}function busCompareFunction(a){return 6==a.length?function(b){return b.busId[0]==a[0]&&b.busId.substr(2)==a.substr(2)}:function(b){return b.licenseId==a.substr(Math.max(a.length-5,0))}}function convertBusQuery(a){const b=/^([0-9])(?:0|-)([0-9]{4})$/,c=/^([0-9])(?:0|-)([0-9]{4})(?:~|～)([0-9])(?:0|-)([0-9]{4})$/,d=/^(?:苏s*E[^0-9A-Z]{0,4})?([0-9A-Z]{5}|[0-9]{5}(?:D|F))$/i,e=/^(?:苏s*E[^0-9A-Z]{0,4})?([0-9A-Z]{5}|[0-9]{5}(?:D|F))(?:~|～)(?:苏s*E[^0-9A-Z]{0,4})?([0-9A-Z]{5}|[0-9]{5}(?:D|F))$/i,f=/^([^~～*x?#]+)(?:\*|x|\?|#){1,3}$/i;let g={busId:[],licenseId:[]},h=a.split(/,|;|，|；|、|\s+/);return h.forEach((a)=>{let h=null;(h=c.exec(a))?g.busId.push({start:h[1]+'-'+h[2],end:h[3]+'-'+h[4]}):(h=e.exec(a))?g.licenseId.push({start:h[1],end:h[2]}):(h=f.exec(a))?h[1].includes('-')?g.busId.push({prefix:h[1]}):g.licenseId.push({prefix:h[1]}):(h=b.exec(a))?g.busId.push(h[1]+'-'+h[2]):(h=d.exec(a))&&g.licenseId.push(h[1])}),g}function findBusById(a){let b=document.getElementById('resultList');removeChildren(b);let c=lineDataManager.queryBuses(convertBusQuery(a),currentStartDate,currentEndDate);c.lines.forEach((a)=>{var c=document.createElement('option');c.value=a,c.appendChild(document.createTextNode(a)),b.appendChild(c)})}function showLinesNew(a,b,c){'string'==typeof a&&(a=[a]);let d=document.getElementById('content'),e=document.getElementById('legend');if(removeChildren(d),removeChildren(e),a.length>PALETTE.length&&!c)return void d.appendChild(document.createTextNode('Too many lines selected!'));if(!b&&!lineDataManager.containsLines(a))return void d.appendChild(document.createTextNode('Not all lines exist!'));1<a.length&&a.forEach((a,b)=>{let c=document.createElement('span'),d=document.createElement('span');d.style.backgroundColor='rgb('+PALETTE[b].join(',')+')',d.style.height='1em',d.style.width='2em',d.style.display='inline-block',c.style.marginLeft='3em',c.appendChild(d),c.appendChild(document.createTextNode(' '+a)),e.appendChild(c)});let f=b||lineDataManager.queryLines(a,currentStartDate,currentEndDate),g=document.createElement('table');g.appendChild(createTableHeader(f.buses));let h=document.createElement('tbody');f.details.forEach((b)=>{var d=document.createElement('tr'),e=document.createElement('th');e.appendChild(document.createTextNode(b[0])),d.appendChild(e),f.buses.forEach((e,f)=>{var g=document.createElement('td');d.appendChild(g);var h=0;h=b[1][f].filter((a)=>0<a).length,0==h||b[1][f].forEach((b,d)=>{if(0<b){var e=document.createElement('span');e.style.height='100%',e.style.width=100/h+'%',e.style.display='inline-block',c?(e.style.color='rgb('+PALETTE[d%PALETTE.length],e.style.fontWeight='bold',e.style.backgroundColor='rgb('+COLOR_GREY.map((a)=>parseInt((255-a)*(1-b)+a)).join(',')+')',e.style.marginLeft='0.5ex',e.style.marginRight='0.5ex',e.appendChild(document.createTextNode(a[d]))):(e.style.backgroundColor='rgb('+(1==a.length?COLOR:PALETTE[d]).map((a)=>parseInt((255-a)*(1-b)+a)).join(',')+')',e.appendChild(document.createTextNode('\xA0'))),e.setAttribute('data-line',a[d]),g.appendChild(e)}})}),h.appendChild(d)}),g.appendChild(h),d.appendChild(g)}function showLines(a){var b=document.getElementById('content'),c=document.getElementById('legend');if(removeChildren(b),removeChildren(c),a.length>PALETTE.length)return void b.appendChild(document.createTextNode('Too many lines selected!'));if(a.some(function(a){return!lineData[a]}))return void b.appendChild(document.createTextNode('Not all lines exist!'));for(var d=0;d<a.length;++d){var e=document.createElement('span'),f=document.createElement('span');f.style.backgroundColor='rgb('+PALETTE[d].join(',')+')',f.style.height='1em',f.style.width='2em',f.style.display='inline-block',e.style.marginLeft='3em',e.appendChild(f),e.appendChild(document.createTextNode(' '+a[d])),c.appendChild(e)}for(var g=[],h=new Set,i={},d=0;d<a.length;++d)currentLineData=lineData[a[d]],currentLineData.buses.forEach(function(a){h.has(a.licenseId)||(g.push(a),h.add(a.licenseId))}),currentLineData.details.forEach(function(b){i[b[0]]||(i[b[0]]={});for(var c,e=0;e<currentLineData.buses.length;++e)c=currentLineData.buses[e].licenseId,i[b[0]][c]||(i[b[0]][c]=Array(a.length).fill(0)),i[b[0]][c][d]=b[1][e]});g.sort(function(c,a){return c.busId&&a.busId?c.busId<a.busId?-1:c.busId>a.busId?1:0:c.busId&&!a.busId?-1:!c.busId&&a.busId?1:c.licenseId<a.licenseId?-1:c.licenseId>a.licenseId?1:0});var j=document.createElement('table');j.appendChild(createTableHeader(g));var k=document.createElement('tbody');Object.keys(i).sort().forEach(function(b){var c=document.createElement('tr'),d=document.createElement('th');d.appendChild(document.createTextNode(b)),c.appendChild(d),g.forEach(function(d){var e=document.createElement('td');c.appendChild(e);var f=0;i[b][d.licenseId]&&(f=i[b][d.licenseId].filter(function(a){return 0<a}).length),0==f||i[b][d.licenseId].forEach(function(b,c){if(0<b){var d=document.createElement('span');d.style.height='100%',d.style.width='calc(100%/'+f+')',d.style.display='inline-block',d.style.backgroundColor='rgb('+PALETTE[c].map(function(a){return parseInt((255-a)*(1-b)+a)}).join(',')+')',d.appendChild(document.createTextNode('\xA0')),d.setAttribute('data-line',a[c]),e.appendChild(d)}})}),k.appendChild(c)}),j.appendChild(k),b.appendChild(j)}function onChooseLine(){if(document.getElementById('compare').checked){if(activeLines.includes(this.value))return;activeLines.push(this.value),history.pushState(activeLines,'','#'+activeLines.join('+')),showLinesNew(activeLines)}else{var a=this.value;activeLines=[a],showLinesNew(a),history.pushState(a,'','#'+a)}}function parseUrlHash(){if(location.hash.replace('#','')){var a=location.hash.replace('#','');return a.includes('+')?(activeLines=a.split('+'),showLinesNew(activeLines)):(activeLines=[a],lineChooser.value=a,showLinesNew(a)),!0}}function onModifyDate(){let a=document.getElementById('startDate'),b=document.getElementById('endDate');if(!(lineDataManager.isDateRangeValid(a.value,b.value)&&(currentStartDate!=a.value||currentEndDate!=b.value)))a.value=currentStartDate,b.value=currentEndDate;else if(currentStartDate=a.value,currentEndDate=b.value,lineDataManager.isDataLoaded(currentStartDate,currentEndDate))showLinesNew(activeLines);else{let a=document.getElementById('progress');document.getElementById('progressbar').style.width=0,progressbar.innerText='Loading...',a.style.display='',lineDataManager.load(currentStartDate,currentEndDate).then(()=>{a.style.display='none',updateLineChooser(lineDataManager.getLines()),showLinesNew(activeLines)})}}function init(){function a(a,b,c){var d=document.getElementById('cellDetails');if('none'!=d.style.display){var e=document.getElementById('cellLineContainer'),f=a;'span'==f.tagName.toLowerCase()?(f=f.parentElement,e.style.display='',document.getElementById('cellLine').innerText=a.getAttribute('data-line')):e.style.display='none',document.getElementById('cellDate').innerText=f.parentElement.children[0].innerText;var g=document.getElementById('content').querySelector('table thead');document.getElementById('cellBusId').innerText=g.children[0].children[f.cellIndex].innerText,document.getElementById('cellLicenseId').innerText=g.children[1].children[f.cellIndex].innerText,d.style.left=b+document.body.scrollLeft+document.documentElement.scrollLeft+8+'px',d.style.top=c+document.body.scrollTop+document.documentElement.scrollTop+8+'px'}}function b(){var a=document.getElementById('cellDetails');a.style.display='none'!=a.style.display||document.getElementById('disableInfotip').checked?'none':''}let c=document.getElementById('lineChooser'),d=document.getElementById('startDate'),e=document.getElementById('endDate');lineDataManager.onUpdateProgress=function(a){let b=document.getElementById('progressbar'),c=100*a.reduce((a,b)=>b.loaded?++a:a,0)/a.length;b.style.width=c+'%',b.innerText='Loading...'+Math.round(c)+'%'},lineDataManager.load(currentStartDate,currentEndDate).then(()=>{document.getElementById('progress').style.display='none',updateLineChooser(lineDataManager.getLines()),parseUrlHash()||(activeLines=[c.children[0].value],showLinesNew(activeLines)),loadRemoteManifest()}),d.value=currentStartDate,e.value=currentEndDate,d.addEventListener('change',onModifyDate),e.addEventListener('change',onModifyDate),c.addEventListener('change',onChooseLine),document.getElementById('resultList').addEventListener('change',onChooseLine),window.onpopstate=function(a){a.state instanceof Array?(activeLines=a.state,showLinesNew(activeLines)):a.state?(activeLines=[a.state],showLinesNew(a.state)):parseUrlHash()},document.getElementById('bus_query').addEventListener('input',function(){findBusById(this.value)}),document.getElementById('findDetails').addEventListener('click',function(){let a=lineDataManager.queryBuses(Object.assign({lines:[].map.call(document.getElementById('resultList').children,(a)=>a.value)},convertBusQuery(document.getElementById('bus_query').value)),currentStartDate,currentEndDate,!0);showLinesNew(a.lines,a,!0)}),document.getElementById('content').addEventListener('click',function(c){var d=c.target?c.target.tagName.toLowerCase():'';('span'==d||'td'==d)&&(b(),a(c.target,c.clientX,c.clientY))});var f=!1,g=null;document.getElementById('content').addEventListener('touchstart',function(c){var d=c.target?c.target.tagName.toLowerCase():'';'span'!=d&&'td'!=d||1!=c.touches.length||f||(f=!0,g=window.setTimeout(function(){f&&(b(),a(c.target,c.touches[0].clientX,c.touches[0].clientY),f=!1,g=null)},1500))}),document.getElementById('content').addEventListener('touchmove',function(){f&&(f=!1,window.clearTimeout(g),timeout=null)}),document.getElementById('content').addEventListener('touchend',function(b){var c=b.target?b.target.tagName.toLowerCase():'';('span'==c||'td'==c&&1==b.touches.length&&f)&&(b.preventDefault(),a(b.target,b.touches[0].clientX,b.touches[0].clientY),f=!1,window.clearTimeout(g),timeout=null)}),document.getElementById('content').addEventListener('mouseover',function(b){var c=b.target?b.target.tagName.toLowerCase():'';('span'==c||'td'==c)&&a(b.target,b.clientX,b.clientY)})}(function(){function a(){b||(init(),b=!0)}let b=!1;document.onload=a,document.onreadystatechange=function(){'complete'==document.readyState&&a()},document.addEventListener('DOMContentLoaded',a)})();

//# sourceMappingURL=buses.min.js.map</script>
  </head>
  <body>
    <div style="margin-bottom: 1em">
      Choose line:
      <select id="lineChooser"></select>
      <label><input type="checkbox" id="compare">+ Compare</label>
      <span style="margin-left: 0.6em">
        <input type="date" id="startDate">
        ~
        <input type="date" id="endDate">
      </span>
      <span style="margin-left: 1.2em">
        Find bus:
        <input type="text" id="bus_query" size="20">
        <select id="resultList"></select>
        <button id="findDetails">
          Search
        </button>
      </span>
      <label><input type="checkbox" id="disableInfotip">Disable infotip</label>
      <span style="margin-left: 1.2em;display:none" id="last_update_container">
        Last update: <span id="last_update_time"></span>
      </span>
    </div>
    <div id="progress">
      <div id="progressbar">Loading...</div>
    </div>
    <div id="offline_prompt" style="display:none">
      You're offline now. Data shown below may not be up-to-date.
    </div>
    <div id="legend"></div>
    <div id="content"></div>
    <div id="cellDetails" style="display:none">
      Date: <span id="cellDate"></span><br>
      <span id="cellLineContainer" style="display:none">
        Line: <span id="cellLine"></span><br>
      </span>
      Bus ID: <span id="cellBusId"></span><br>
      License ID: <span id="cellLicenseId"></span>
    </div>
  </body>
</html>
