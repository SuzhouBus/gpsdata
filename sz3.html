<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Buses</title>
    <script data-feature-detection>
      if (!window.Promise) {
        location.replace('sz3.legacy.html');
      }
    </script>
    
    
    
    <script>
      var manifest = (
// BEGIN MANIFEST
{
  "sources": ["sz3", "sz4", "wj"],
  "last_update_time": "2018-03-26 22:30:01",
  "data": {
    "sz3": "sz3.json",
    "sz4": "sz4.json",
    "wj": "wj.json"
  },
  "size_hints": {
    "sz3": 389,
    "sz4": 316,
    "wj": 5.9
  },
  "start_date": "2018-01-01",
  "lines": {
    "sz3": ["__+BEGIN_LINES+__","1001","100","101","102","102N","108","109","10N","10S","112","118","119","126","142","146","161","166","169","170N","170S","175","178","179","190","190N","190S","19","1","200","200N","200S","202","204","209","218","219","261","262","26","27","27D","2SIP","2SND","3002","301","304","304L","305","307","308","311","311L","312","313","315","317","318","31","321","324","325","32","32Q","331","33","34","34LN","34N","35","360","36","38","406","40E","40W","415","42","441","446","44","45","47","4","501","502","502D","511","513","514","518","521","522","523","526","529","52","53","552","553","557","558","563","56","585","5","602","60","60N","60S","621","622","62","64","65","663","66","67","698","69","69Q","7","810","810E","810W","811","812","813","814","815","816","817","818","819","81","827","82","84","85","865","866","86","871","872","873","875","876","877","878","879","87","89","8","9001","9002","9003","9004","9005","9006","9007","9008","9009","900","900N","900S","9011","902","921","922","923","925","926","928","931","932","933","935","937","949","970","970E","970W","980","980E","980W","9","G10","G11","G12","G2N","G2S","G8","J3","K1","K6","K7","N1","N2","N3","N5","XT","Y1","Y1N","Y1S","Y2","Y3","Y4","Y4L","Y5","Y5N","Y5S","__+END_LINES+__"],
    "sz4": ["__+BEGIN_LINES+__","1001E","1001W","100N","100S","106","106Q","110N","110S","111","116","120E","120W","127","129","132","136","141","150N","150S","152","156","158","162","16","175","176","180N","180S","182","185","206","207","215","238","28","3002","300N","300S","302","303","306","309","316","319","322","326","328","329","332","333","335","336","336Q","338","356","357","360","37","39","3","400E","400W","43","442","443","445","5005","503","504","505","508","509","512","518","51","528","54","557","55","560","58","59","611","612","615","623","627","628","63","691","692","6","801","802","803","804","805","805Q","806","807","808","809","80","80N","80S","810E","810W","811","812","813","814","815","816","817","818","819","81","820","820E","820W","821","822","823","824","825","826","828","82","831","832","833","835","836","837","839","83","84","851","852","853","854","855","856","85","85D","861","862","863","864","865","866","86","871","872","873","875","876","877","878","879","87","881","882","883","88","89","9001","9002","9002E","9002W","9003","9004","9005","9005E","9005W","9006","9007","9008","9009","9010","9011","9012","9013","9026","922","925","928","G6","G7","JLJ","K3","K5","K8","K8Z","N10","N4","N6","N7","N8","N9","SP","SZL","__+END_LINES+__"]
  },
  "archives": {
    "sz3": {
      "path": "archive/sz3/",
      "start_date": "2016-11-23",
      "end_date": "2018-02-28"
    },
    "sz4": {
      "path": "archive/sz4/",
      "start_date": "2017-04-15",
      "end_date": "2018-02-28"
    }
  }
}
// END MANIFEST
      );
    </script>
    <style>
      th, td:nth-child(1) {
        white-space: nowrap;
      }

      #cellDetails {
        position: absolute;
        border: black solid 2px;
        padding: 8px;
        background-color: #f0e5a6;
        white-space: nowrap;
      }

      #progress {
        margin-left: 3em;
        margin-right: 3em;
        border: black 3px solid;
      }

      #progressbar {
        background-color: #0000ff;
        height: 1.2em;
        width: 0;
        text-align: center;
      }

      #offline_prompt {
        background-color: #ff9999;
        border: red 4px solid;
        text-align: center;
        font-weight: bold;
      }

      #contents th, #contents td {
      }

      .busid_range_begin {
      }

      .busid_odd_range_element {
        background-color: #f0f080;
      }

      .busid_even_range_element {
        background-color: #c8f9f9;
      }

      .busid_range_end {
      }
    </style>
    <script>var COLOR = [106, 90, 205];
var PALETTE = [
  [230, 25, 75],
  [60, 180, 75],
  [255, 225, 25],
  [0, 130, 200],
  [245, 130, 48],
  [145, 30, 180],
  [70, 240, 240],
  [240, 50, 230],
  [210, 245, 60],
  [250, 190, 190],
  [0, 128, 128],
  [170, 110, 40],
  [128, 0, 0],
  [170, 255, 195],
  [128, 128, 0],
  [0, 0, 128],
  [128, 128, 128],
];
var lineData = {};
var lineNameMap = {};
var lineSourceMap = {};
var activeLines = [];
var currentStartDate;
var currentEndDate;

class DateUtils {
  static formatNumber_(number) {
    let result = number.toString();
    return result.length == 1 ? '0' + result : result;
  }

  static formatDate(y, m, d) {
    let result = y.toString();
    if (m) {
      result += '-' + DateUtils.formatNumber_(m);
    }
    if (d) {
      result +=  '-' + DateUtils.formatNumber_(d);
    }
    return result;
  }

  static toYearMonth(date) {
    let monthIndexMinusOne = date.indexOf('-');
    if (monthIndexMinusOne == -1)
      return date;
    let dayIndexMinusOne = date.indexOf('-', monthIndexMinusOne + 1);
    if (dayIndexMinusOne == -1)
      return date;
    return date.substr(0, dayIndexMinusOne);
  }

  static nextMonth(date) {
    let components = date.split('-');
    components[1]++;
    if (components[1] > 12) {
      components[0] += components[1] / 12;
      components[1] %= 12;
    }
    if (components[2] && components[2] > DateUtils.daysInMonthsMap_[components[1]])
      components[2] = DateUtils.daysInMonthsMap_[components[1]];
    return DateUtils.formatDate.apply(null, components);
  }

  static previousMonth(date) {
    let components = date;
    if (typeof date == 'string')
      components = date.split('-');
    components[1]--;
    if (components[1] == 0) {
      components[0]--;
      components[1] = 12;
    }
    if (components[2] && components[2] > DateUtils.daysInMonthsMap_[components[1]])
      components[2] = DateUtils.daysInMonth(components[1]);
    return DateUtils.formatDate.apply(null, components);
  }

  static yesterday(date) {
    let components = date.split('-');
    components[2]--;
    if (components[2] == 0) {
      let ym = DateUtils.previousMonth(components.slice(0, 2));
      let ymc = ym.split('-');
      return ym + '-' + DateUtils.formatNumber_(DateUtils.daysInMonth(ymc[0], ymc[1]));
    }
  }

  static isLeapYear(year) {
    year = parseInt(year);
    return year % 400 == 0 || (year % 100 != 0 && year % 4 == 0);
  }

  static daysInMonth(year, month) {
    month = parseInt(month);
    return month == 2 && isLeapYear(year) ? 29 : DateUtils.daysInMonthsMap_[month];
  }
}

DateUtils.daysInMonthsMap_ = [
  undefined, // 0
  31, // Jan
  28, // Feb (NON LEAP YEAR)
  31, // Mar
  30, // Apr
  31, // May
  30, // Jun
  31, // Jul
  31, // Aug
  30, // Sep
  31, // Oct
  30, // Nov
  31, // Dec
];

class LineDataManager {
  constructor(manifest) {
    this.manifest = manifest;
    this.loadedLineData_ = {};
    this.lineData_ = {};

    let today = new Date();
    today.setMinutes(today.getMinutes() - today.getTimezoneOffset());
    this.today_ = today.toISOString().substr(0, 10);

    this.earliestDate = Object.keys(manifest.archives || {}).
        map(source => manifest.archives[source].start_date).
        concat([manifest.start_date]).
        reduce((result, date) => date < result ? date : result, '9999-99-99');

    this.initializeLineNameMap_(manifest);
  }

  initializeLineNameMap_(manifest) {
    this.lineNameMap_ = {};
    var existingLines = {};
    manifest.sources.forEach(source => {
      this.lineNameMap_[source] = {};
      if (manifest.lines[source]) {
        manifest.lines[source].forEach(lineName => {
          if (lineName != '__+BEGIN_LINES+__' && lineName != '__+END_LINES+__' && existingLines[lineName]) {
            var i;
            for (i = 2; existingLines[lineName + '_' + i]; ++i);
            existingLines[lineName + '_' + i] = true;
            this.lineNameMap_[source][lineName] = lineName + '_' + i;
          } else {
            existingLines[lineName] = true;
          }
        });
      }
    });
  }

  appendLineDataToLoad_(dataToLoad, month, sourceOrSources) {
    if (typeof sourceOrSources == 'string')
      sourceOrSources = [sourceOrSources];
    else if (sourceOrSources == undefined) {
      sourceOrSources = this.manifest.sources;
    }
    Array.prototype.push.apply(dataToLoad,
        sourceOrSources.filter(source => !this.loadedLineData_[month] || !this.loadedLineData_[month][source]).
        map(source => ({month: month, source: source})));
    return dataToLoad;
  }

  isRangeOverlapped_(start1, end1, start2, end2) {
    return start1 <= end2 && end1 >= start2;
  }

  async load(startDate, endDate) {
    let dataToLoad = [];
    if (this.isRangeOverlapped_(startDate, endDate, this.manifest.start_date, this.today_)) {
      this.appendLineDataToLoad_(dataToLoad, 'current');
    }

    if (startDate < this.manifest.start_date) { // [-inf, manifest.start_date) and [startDate, endDate] have intersection
      if (startDate < this.earliestDate)
        startDate = this.earliestDate;
      if (endDate >= this.manifest.start_date)
        endDate = DateUtils.yesterday(this.manifest.start_date);

      if (startDate <= endDate) {
        let startMonth = DateUtils.toYearMonth(startDate);
        let endMonth = DateUtils.toYearMonth(endDate);
        let archivedSources = Object.keys(this.manifest.archives || {}).map(source => {
          let result = Object.assign({}, this.manifest.archives[source], {name: source});
          result.start_month = DateUtils.toYearMonth(result.start_date);
          result.end_month = DateUtils.toYearMonth(result.end_date);
          return result;
        }).filter(source => this.isRangeOverlapped_(startDate, endDate, source.start_date, source.end_date));
        for (let currentMonth = DateUtils.toYearMonth(startDate);
            currentMonth <= DateUtils.toYearMonth(endDate);
            currentMonth = DateUtils.nextMonth(currentMonth)) {
          this.appendLineDataToLoad_(dataToLoad, currentMonth,
              archivedSources.filter(source => currentMonth >= source.start_month && currentMonth <= source.end_month).
              map(source => source.name));
        }
      }
    }
    
    dataToLoad.forEach(async item => {
      let path;
      if (item.month == 'current') {
        path = this.manifest.data[item.source];
      } else {
        path = this.manifest.archives[item.source].path + item.month.replace('-', '') + '.json';
      }
      await fetch(path).then(x => x.json()).then(data => {
        if (!this.loadedLineData_[item.month])
          this.loadedLineData_[item.month] = {};
        this.loadedLineData_[item.month][item.source] = data;
        this.importData_(item.month, item.source);
        item.loaded = true;
        this.onUpdateProgress && this.onUpdateProgress(dataToLoad, item.month, item.source, 1, 1);
      }).catch(_ => item.loaded = false, Promise.resolve());
    });

    return dataToLoad;
  }

  importData_(month, source) {
    let data = this.loadedLineData_[month][source];
    Object.keys(data).forEach(line => {
      let lineName = this.lineNameMap_[source][line] || line;
      if (!this.lineData_[lineName])
        this.lineData_[lineName] = {};
      this.lineData_[lineName][month] = data[line];
    });
  }

  query(lineOrLines, startDate, endDate) {
    // See also getFilteredLineData & showLines
  }
}

(function() {
  var today = new Date();
  today.setMinutes(today.getMinutes() - today.getTimezoneOffset());
  currentEndDate = today.toISOString().substr(0, 10);
  var month = today.getMonth();
  today.setMonth(today.getMonth() - 1);
  if (month == today.getMonth())
    today.setDate(0);
  currentStartDate = today.toISOString().substr(0, 10);
})();

function loadData() {
  var existingLines = {};
  manifest.sources.forEach(function(source) {
    lineNameMap[source] = {};
    if (manifest.lines[source]) {
      manifest.lines[source].forEach(function(lineName) {
        if (lineName != '__+BEGIN_LINES+__' && lineName != '__+END_LINES+__' && existingLines[lineName]) {
          var i;
          for (i = 2; existingLines[lineName + '_' + i]; ++i);
          existingLines[lineName + '_' + i] = true;
          lineNameMap[source][lineName] = lineName + '_' + i;
        } else {
          existingLines[lineName] = true;
        }
      });
    }
  });

  var progress = {};
  manifest.sources.forEach(function(source) {
    progress[source] = {total: 0, loaded: 0, weight: 1 / manifest.sources.length};
  });
  if (manifest.size_hints) {
    var remainingWeight = 1;
    var size_hints_total = 0;
    for (var k in manifest.size_hints) {
      if (manifest.size_hints[k])
        size_hints_total += manifest.size_hints[k];
      else
        remainingProgress -= 1 / manifest.sources.length;
    }
    for (var k in manifest.size_hints) {
      if (manifest.size_hints[k]) {
        progress[k].weight = remainingWeight * manifest.size_hints[k] / size_hints_total;
      }
    }
  }

  function updateProgress(source, loaded, total) {
    var originalTotal = progress[source].total;
    progress[source].total = total;
    progress[source].loaded = loaded;

    if (originalTotal != total) {
      var remainingWeight = 1;
      var knownTotal = 0;
      for (var k in progress) {
        if (progress[k].total == 0) {
          remainingWeight -= progress[k].weight;
        } else {
          knownTotal += progress[k].total;
        }
      }
      for (var k in progress) {
        if (progress[k].total != 0) {
          progress[k].weight = remainingWeight * progress[k].total / knownTotal;
        }
      }
    }

    var progressValue = 0;
    for (var k in progress) {
      if (progress[k].total != 0)
        progressValue += progress[k].loaded / progress[k].total * progress[k].weight;
    }

    if (progressValue > 1)
      progressValue = 1;
    document.getElementById('progressbar').style.width = progressValue * 100 + '%';
    document.getElementById('progressbar').innerText = 'Loading...' + Math.round(progressValue * 100) + '%';
  }

  Promise.all(manifest.sources.map(function(source) {
    return new Promise(function(resolve, reject) {
      var path = manifest.data[source];
      var xhr = new XMLHttpRequest();
      xhr.open('GET', path, true);
      xhr.onreadystatechange = function() {
        if (xhr.readyState == 4 && xhr.status == 200) {
          var json = xhr.responseText;
          if (json.indexOf('__BUS_LINE_DATA') != -1) {
            json = json.replace(/var __BUS_LINE_DATA=JSON\.parse\('|\\\n|'\)$/g, '');
          }
          var data = JSON.parse(json);
          for (var line in data) {
            var lineName = line;
            if (lineNameMap[source] && lineNameMap[source][line])
              lineName = lineNameMap[source][line];
            var lineDetails = data[line];
            if (lineData[lineName]) {
              console.warn('New line name conflict!');
              var i;
              for (i = 2; lineData[lineName + '_' + i]; ++i);
              lineData[lineName + '_' + i] = lineDetails;
            } else
              lineData[lineName] = lineDetails;
          }
          updateProgress(source, 1, 1);
          resolve();
        } else if (xhr.readyState == 4) {
          // TODO: Error handling.
          // Note: Still resolve() because Promise.all does not wait for other pending promises if any one rejects.
          resolve();
        }
      };
      xhr.onprogress = function(e) {
        if (e.lengthComputable) {
          updateProgress(source, e.loaded, e.total);
        }
      };
      xhr.send()
    });
  })).then(function() {
    document.getElementById('progress').style.display = 'none';
    initializeLineChooser();
    loadRemoteManifest();
  });
}

function loadRemoteManifest() {
  fetch('manifest.json', {cache: 'no-cache'}).then(r => r.json()).then(manifest => {
    document.getElementById('last_update_container').style.display = '';
    document.getElementById('last_update_time').appendChild(document.createTextNode(manifest.last_update_time));
  }).catch(_ => {
    document.getElementById('offline_prompt').style.display = '';
  });
}

function isBusIdContinuous(a, b) {
  if (a.substr(0, 2) != b.substr(0, 2))
    return false;
  var ia = parseInt(a.substr(2));
  var ib = parseInt(b.substr(2));
  if (ia == ib + 1 || ib == ia + 1)
    return true;
  else if (a.substr(0, 2) == '5-' &&
      ((ia % 10 == 3 && ia + 2 == ib) || 
       (ib % 10 == 3 && ib + 2 == ia)))
    return true;
  return false;
}

function initializeLineChooser() {
  var lineChooser = document.getElementById('lineChooser');
  Object.keys(lineData).sort(function(a, b) {
    var ia = parseInt(a);
    var ib = parseInt(b);
    var defaultComparisonResult;

    if (a < b)
      defaultComparisonResult = -1;
    else if (a > b)
      defaultComparisonResult = 1;
    else
      defaultComparisonResult = 0;

    if (isNaN(ia) && isNaN(ib)) {
      return defaultComparisonResult;
    } else if (isNaN(ia) && !isNaN(ib)) { // a (NaN) > b (Number)
      return 1;
    } else if (!isNaN(ia) && isNaN(ib)) { // a (Number) < b (NaN)
      return -1;
    } else { // Both a & b are numbers
      if (ia < ib)
        return -1;
      else if (ia > ib)
        return 1;
      else
        return defaultComparisonResult;
    }
  }).forEach(function(line) {
    var option = document.createElement('option');
    option.value = line;
    option.appendChild(document.createTextNode(line));
    lineChooser.appendChild(option);
  });

  if (!parseUrlHash())
    showLine(lineChooser.children[0].value);
}

function fillTr(data, th, attrs) {
  var tr = document.createElement('tr');
  Array.prototype.forEach.call(data, function(item, index) {
    var td = document.createElement(th ? 'th' : 'td');
    if (attrs && attrs[index])
    for (var x in attrs[index])
      td.setAttribute(x, attrs[index][x]);
    td.appendChild(document.createTextNode(item));
    tr.appendChild(td);
  });
  return tr;
}

function removeChildren(parent) {
  while(parent.hasChildNodes())
    parent.removeChild(parent.childNodes[0]);
}

function createTableHeader(allBuses) {
  var thead = document.createElement('thead');

  var tr = document.createElement('tr');
  var th = document.createElement('th');
  th.appendChild(document.createTextNode('Bus ID'));
  tr.appendChild(th);
  var previousTd = null;
  var inRange = false;
  var odd = false;
  var elementClass = '';
  for (var i = 0; i < allBuses.length; ++i) {
    var td = document.createElement('th');
    td.appendChild(document.createTextNode(allBuses[i].busId));
    tr.appendChild(td);

    elementClass = odd ? 'busid_odd_range_element' : 'busid_even_range_element';
    if (i > 0 && isBusIdContinuous(allBuses[i - 1].busId, allBuses[i].busId)) {
      if (inRange) { // The same range continues.
        previousTd.className = elementClass;
      } else { // A new range begins.
        previousTd.className = 'busid_range_begin ' + elementClass;
        inRange = true;
      }
    } else {
      if (inRange) { // The previous td is the end of the range.
        inRange = false;
        previousTd.className = 'busid_range_end ' + elementClass;
        odd = !odd;
      }
    }
    previousTd = td;
  }
  if (inRange) {
    previousTd.className = 'busid_range_end ' + elementClass;
  }

  thead.appendChild(tr);

  thead.appendChild(fillTr(["License ID"].concat(allBuses.map(bus => bus.licenseId)), true));
  return thead;
}

function getFilteredLineData(lines) {
  if (typeof lines == 'string') {
    var details = lineData[lines].details.filter(day => day[0] >= currentStartDate && day[0] <= currentEndDate).slice();
    var buses = lineData[lines].buses;
    var weightSums = new Array(buses.length).fill(0);
    details.forEach(day => day[1].forEach((weight, index) => weightSums[index] += weight));
    var zeroWeightFilter = (_, index) => weightSums[index] > 0;
    return {
      buses: buses.filter(zeroWeightFilter),
      details: details.map(day => [day[0], day[1].filter(zeroWeightFilter)])
    };
  } else {
    console.error('Not implemented');
  }
}

function showLine(line) {
  activeLines = [line];
  var content = document.getElementById('content');
  removeChildren(content);
  if (!lineData[line]) {
    content.appendChild(document.createTextNode('Line ' + line + ' does not exist!'));
    return;
  }

  var data = getFilteredLineData(line);

  var table = document.createElement('table');
  table.appendChild(createTableHeader(data.buses));
  var tbody = document.createElement('tbody');
  data.details.forEach(function(day) {
    tbody.appendChild(fillTr([day[0]].concat(new Array(day[1].length).fill('')), false, [''].concat(day[1].map(function(weight){
      return {style: 'background-color:rgb(' + COLOR.map(function(value) {
        return parseInt((255 - value) * (1 - weight) + value);
      }).join(',') + ')'};
    }))));
  });
  table.appendChild(tbody);
  content.appendChild(table);
}

function busCompareFunction(query) {
  if (query.length == 6) {
    return function(bus) {
      return bus.busId[0] == query[0] && bus.busId.substr(2) == query.substr(2);
    }
  } else { // if (query.length >= 5)
    return function(bus) {
      return bus.licenseId == query.substr(Math.max(query.length - 5, 0));
    }
  }
}

function findBusById(query) {
  var resultList = document.getElementById('resultList');
  removeChildren(resultList);
  for (var line in lineData) {
    if (lineData[line].buses.some(busCompareFunction(query))) {
      var option = document.createElement('option');
      option.value = line;
      option.appendChild(document.createTextNode(line));
      resultList.appendChild(option);
    }
  }
}

function showLines(lines) {
  var content = document.getElementById('content');
  var legend = document.getElementById('legend');
  removeChildren(content);
  removeChildren(legend);

  if (lines.length > PALETTE.length) {
    content.appendChild(document.createTextNode('Too many lines selected!'));
    return;
  }

  if (lines.some(function(line) {
    return !lineData[line];
  })) {
    content.appendChild(document.createTextNode('Not all lines exist!'));
    return;
  }

  for (var i = 0; i < lines.length; ++i) {
    var item = document.createElement('span');
    var span = document.createElement('span');
    span.style.backgroundColor = 'rgb(' + PALETTE[i].join(',') + ')';
    span.style.height = '1em';
    span.style.width = '2em';
    span.style.display = 'inline-block';
    item.style.marginLeft = '3em';
    item.appendChild(span);
    item.appendChild(document.createTextNode(' ' + lines[i]));
    legend.appendChild(item);
  }

  var allBuses = [];
  var licenseIdSet = new Set();
  var lineDetailsMap = {};
  for (var i = 0; i < lines.length; ++i) {
    currentLineData = lineData[lines[i]];

    currentLineData.buses.forEach(function(bus) {
      if (!licenseIdSet.has(bus.licenseId)) {
        allBuses.push(bus);
        licenseIdSet.add(bus.licenseId);
      }
    });
    currentLineData.details.forEach(function(day) {
      if (!lineDetailsMap[day[0]]) {
        lineDetailsMap[day[0]] = {};
      }
      for (var j = 0; j < currentLineData.buses.length; ++j) {
        var licenseId = currentLineData.buses[j].licenseId;
        if (!lineDetailsMap[day[0]][licenseId])
          lineDetailsMap[day[0]][licenseId] = new Array(lines.length).fill(0);
        lineDetailsMap[day[0]][licenseId][i] = day[1][j];
      }
    });
  }

  allBuses.sort(function(a, b) {
    if (a.busId && b.busId) {
      if (a.busId < b.busId)
        return -1;
      else if (a.busId > b.busId)
        return 1;
      else
        return 0;
    } else if (a.busId && !b.busId) // a < b
      return -1;
    else if (!a.busId && b.busId) // a > b
      return 1;
    else {
      if (a.licenseId < b.licenseId)
        return -1;
      else if (a.licenseId > b.licenseId)
        return 1;
      return 0;
    }
  });

  var table = document.createElement('table');
  table.appendChild(createTableHeader(allBuses));
  var tbody = document.createElement('tbody');
  Object.keys(lineDetailsMap).sort().forEach(function(date) {
    var tr = document.createElement('tr');
    var th = document.createElement('th');
    th.appendChild(document.createTextNode(date));
    tr.appendChild(th);
    allBuses.forEach(function(bus) {
      var td = document.createElement('td');
      tr.appendChild(td);
      var activeCount = 0;
      if (lineDetailsMap[date][bus.licenseId]) {
        activeCount = lineDetailsMap[date][bus.licenseId].filter(function(weight) {
          return weight > 0;
        }).length;
      }
      if (activeCount == 0)
        return;

      lineDetailsMap[date][bus.licenseId].forEach(function(weight, index) {
        if (weight > 0) {
          var span = document.createElement('span');
          span.style.height = '100%';
          span.style.width = 'calc(100%/' + activeCount + ')';
          span.style.display = 'inline-block';
          span.style.backgroundColor = 'rgb(' + PALETTE[index].map(function(value) {
            return parseInt((255 - value) * (1 - weight) + value);
          }).join(',') + ')';
          span.appendChild(document.createTextNode('\u00a0'));
          span.setAttribute('data-line', lines[index]);
          td.appendChild(span);
        }
      });
    });
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
  content.appendChild(table);
}

function onChooseLine() {
  if (document.getElementById('compare').checked) {
    if (activeLines.includes(this.value))
      return;
    activeLines.push(this.value);
    history.pushState(activeLines, '', '#' + activeLines.join('+'));
    showLines(activeLines);
  } else {
    var line = this.value;
    showLine(line);
    history.pushState(line, '', '#' + line);
  }
}

function loadDataFromFile(url, callback) {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src = url;
  document.head.appendChild(script);
  script.onload = function() {
    callback(__BUS_LINE_DATA, url);
  };
}

function parseUrlHash() {
  if (location.hash.replace('#', '')) {
    var hashValue = location.hash.replace('#', '');
    if (hashValue.includes('+')) {
      activeLines = hashValue.split('+');
      showLines(hashValue.split('+'));
    } else
      showLine(lineChooser.value = hashValue);
    return true;
  }
}

document.addEventListener('DOMContentLoaded', function() {
  loadData();

  document.getElementById('startDate').value = currentStartDate;
  document.getElementById('endDate').value = currentEndDate;
  lineChooser.addEventListener('change', onChooseLine);
  document.getElementById('resultList').addEventListener('change', onChooseLine);
  window.onpopstate = function(e) {
    if (e.state instanceof Array) {
      activeLines = e.state;
      showLines(activeLines);
    } else if(e.state) {
      showLine(e.state);
    } else {
      parseUrlHash();
    }
  };
  document.getElementById('busid').addEventListener('input', function() {
    findBusById(this.value);
  });
  document.getElementById('findRecent').addEventListener('click', function() {
    var findRecentDays = parseInt(document.getElementById('findRecentDays').value) || 15;
    var query = document.getElementById('busid').value;
    var results = {};
    [].map.call(document.getElementById('resultList').children, function(option) {
      return option.value;
    }).forEach(function(line) {
      var days = lineData[line].details;
      var index = lineData[line].buses.findIndex(busCompareFunction(query));
      for (var i = Math.max(days.length - findRecentDays, 0); i < days.length; ++i) {
        var date = days[i][0];
        var weight = days[i][1][index];
        if (weight) {
          var item = {line: line, weight: weight};
          if (results[date])
            results[date].push(item);
          else
            results[date] = [item];
        }
      }
    });
    var dates = Object.keys(results).sort();
    dates = dates.slice(Math.max(dates.length - findRecentDays, 0));
    alert(dates.map(function(date) {
      return date + ': ' + results[date].map(function(item) {
        return item.line + ' (' + item.weight + ')';
      }).join(', ');
    }).join('\n'));
  });
  ['click', 'mousedown', 'mouseup', 'touchstart', 'touchend'].forEach(function(event) {
    document.getElementById('findRecentDays').addEventListener(event, function(e) {
      e.stopPropagation();
    });
  });

  function updateCellDetails(element, x, y) {
    var div = document.getElementById('cellDetails');
    if (div.style.display == 'none')
      return;

    var lineContainer = document.getElementById('cellLineContainer');
    var td = element;
    if (td.tagName.toLowerCase() == 'span') {
      td = td.parentElement;
      lineContainer.style.display = '';
      document.getElementById('cellLine').innerText = element.getAttribute('data-line');
    } else {
      lineContainer.style.display = 'none';
    }
    document.getElementById('cellDate').innerText = td.parentElement.children[0].innerText;
    var thead = document.getElementById('content').querySelector('table thead');
    document.getElementById('cellBusId').innerText = thead.children[0].children[td.cellIndex].innerText;
    document.getElementById('cellLicenseId').innerText = thead.children[1].children[td.cellIndex].innerText;
    div.style.left = x + document.body.scrollLeft + document.documentElement.scrollLeft + 8 + 'px';
    div.style.top = y + document.body.scrollTop + document.documentElement.scrollTop + 8 + 'px';
  }

  function toggleCellDetails() {
    var div = document.getElementById('cellDetails');
    div.style.display =
        (div.style.display == 'none' && !document.getElementById('disableInfotip').checked) ?
        '' : 'none';
  }

  document.getElementById('content').addEventListener('click', function(e) {
    var tagName = e.target ? e.target.tagName.toLowerCase() : '';
    if (tagName == 'span' || tagName == 'td') {
      toggleCellDetails();
      updateCellDetails(e.target, e.clientX, e.clientY);
    }
  });
  var touchStarted = false;
  var timer = null;
  document.getElementById('content').addEventListener('touchstart', function(e) {
    var tagName = e.target ? e.target.tagName.toLowerCase() : '';
    if ((tagName == 'span' || tagName == 'td') && e.touches.length == 1) {
      if (!touchStarted) {
        touchStarted = true;
        timer = window.setTimeout(function() {
          if (touchStarted) {
            toggleCellDetails();
            updateCellDetails(e.target, e.touches[0].clientX, e.touches[0].clientY);
            touchStarted = false;
            timer = null;
          }
        }, 1500);
      }
    }
  });
  document.getElementById('content').addEventListener('touchmove', function(e) {
    if (touchStarted) {
      touchStarted = false;
      window.clearTimeout(timer);
      timeout = null;
    }
  });
  document.getElementById('content').addEventListener('touchend', function(e) {
    var tagName = e.target ? e.target.tagName.toLowerCase() : '';
    if (tagName == 'span' || tagName == 'td' && e.touches.length == 1 && touchStarted) {
      e.preventDefault();
      updateCellDetails(e.target, e.touches[0].clientX, e.touches[0].clientY);
      touchStarted = false;
      window.clearTimeout(timer);
      timeout = null;
    }
  });
  document.getElementById('content').addEventListener('mouseover', function(e) {
    var tagName = e.target ? e.target.tagName.toLowerCase() : '';
    if (tagName == 'span' || tagName == 'td') {
      updateCellDetails(e.target, e.clientX, e.clientY);
    }
  });
});

/*if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/service_worker.js');
} else {
  var iframe = document.createElement('iframe');
  iframe.style.display = 'none';
  iframe.src = 'appcache.html';
  document.body.appendChild(iframe);
}*/
</script>
  </head>
  <body>
    <p>
      Choose line:
      <select id="lineChooser"></select>
      <label><input type="checkbox" id="compare">+ Compare</label>
      <span style="margin-left: 0.6em">
        <input type="date" id="startDate">
        ~
        <input type="date" id="endDate">
      </span>
      <span style="margin-left: 1.2em">
        Find bus:
        <input type="text" id="busid" size="5">
        <select id="resultList"></select>
        <button id="findRecent">
          Find recent
          <input type="text" id="findRecentDays" value="15" size="2">
          days
        </button>
      </span>
      <label><input type="checkbox" id="disableInfotip">Disable infotip</label>
      <span style="margin-left: 1.2em;display:none" id="last_update_container">
        Last update: <span id="last_update_time"></span>
      </span>
    </p>
    <div id="progress">
      <div id="progressbar">Loading...</div>
    </div>
    <div id="offline_prompt" style="display:none">
      You're offline now. Data shown below may not be up-to-date.
    </div>
    <div id="legend"></div>
    <div id="content"></div>
    <div id="cellDetails" style="display:none">
      Date: <span id="cellDate"></span><br>
      <span id="cellLineContainer" style="display:none">
        Line: <span id="cellLine"></span><br>
      </span>
      Bus ID: <span id="cellBusId"></span><br>
      License ID: <span id="cellLicenseId"></span>
    </div>
  </body>
</html>
