<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Buses</title>
    <script data-feature-detection>
      if (!window.Promise) {
        location.replace('sz3.legacy.html');
      }
    </script>
    
    
    <script>
      var manifest = (
// BEGIN MANIFEST
{
  "sources": ["sz3", "sz4", "wj"],
  "data": {
    "sz3": "sz3.json",
    "sz4": "sz4.json",
    "wj": "wj.json"
  },
  "size_hints": {
    "sz3": 389,
    "sz4": 316,
    "wj": 5.9
  },
  "startDate": "2018-01-01",
  "lines": {
    "sz3": ["__+BEGIN_LINES+__","1001","100","101","102","102N","108","109","10N","10S","112","118","119","126","142","146","161","166","169","170N","170S","175","178","179","190","190N","190S","19","1","200","200N","200S","202","204","209","218","219","261","262","26","27","27D","2SIP","2SND","3002","301","304","304L","305","307","308","311","311L","312","313","315","317","318","31","321","324","325","32","32Q","331","33","34","34LN","34N","35","360","36","38","406","40E","40W","415","42","441","446","44","45","47","4","501","502","502D","511","513","514","518","521","522","523","526","529","52","53","552","553","557","558","563","56","585","5","602","60","60N","60S","621","622","62","64","65","663","66","67","698","69","69Q","7","810","810E","810W","811","812","813","814","815","816","817","818","819","81","827","82","84","85","865","866","86","871","872","873","875","876","877","878","879","87","89","8","9001","9002","9003","9004","9005","9006","9007","9008","9009","900","900N","900S","9011","902","921","922","923","925","926","928","931","932","933","935","937","949","970","970E","970W","980","980E","980W","9","G10","G11","G12","G2N","G2S","G8","J3","K1","K6","K7","N1","N2","N3","N5","XT","Y1","Y1N","Y1S","Y2","Y3","Y4","Y4L","Y5","Y5N","Y5S","__+END_LINES+__"],
    "sz4": ["__+BEGIN_LINES+__","1001E","1001W","100N","100S","106","106Q","110N","110S","111","116","120E","120W","127","129","132","136","141","150N","150S","152","156","158","162","16","175","176","180N","180S","182","185","206","207","215","238","28","3002","300N","300S","302","303","306","309","316","319","322","326","328","329","332","333","335","336","336Q","338","356","357","360","37","39","3","400E","400W","43","442","443","445","5005","503","504","505","508","509","512","518","51","528","54","557","55","560","58","59","611","612","615","623","627","628","63","691","692","6","801","802","803","804","805","805Q","806","807","808","809","80","80N","80S","810E","810W","811","812","813","814","815","816","817","818","819","81","820","820E","820W","821","822","823","824","825","826","828","82","831","832","833","835","836","837","839","83","84","851","852","853","854","855","856","85","85D","861","862","863","864","865","866","86","871","872","873","875","876","877","878","879","87","881","882","883","88","89","9001","9002","9002E","9002W","9003","9004","9005","9005E","9005W","9006","9007","9008","9009","9010","9011","9012","9013","9026","922","925","928","G6","G7","JLJ","K3","K5","K8","K8Z","N10","N4","N6","N7","N8","N9","SP","SZL","__+END_LINES+__"]
  },
  "archives": {
    "sz3": [
      {
        "path": "archive/sz3_2016.json",
        "startDate": "2016-11-23",
        "endDate": "2016-12-31"
      },
      {
        "path": "archive/sz3_2017_Q1.json",
        "startDate": "2017-01-01",
        "endDate": "2017-03-31"
      },
      {
        "path": "archive/sz3_2017_Q2.json",
        "startDate": "2017-04-01",
        "endDate": "2017-06-30"
      },
      {
        "path": "archive/sz3_2017_Q3.json",
        "startDate": "2017-07-01",
        "endDate": "2017-09-30"
      },
      {
        "path": "archive/sz3_2017_Q4.json",
        "startDate": "2017-10-01",
        "endDate": "2017-12-31"
      }
    ],
    "sz4": [
      {
        "path": "archive/sz4_2017_Q2.json",
        "startDate": "2017-04-15",
        "endDate": "2017-06-30"
      },
      {
        "path": "archive/sz4_2017_Q3.json",
        "startDate": "2017-07-01",
        "endDate": "2017-09-30"
      },
      {
        "path": "archive/sz4_2017_Q4.json",
        "startDate": "2017-10-01",
        "endDate": "2017-12-31"
      }
    ]
  }
}
// END MANIFEST
      );
    </script>
    <style>
      th, td:nth-child(1) {
        white-space: nowrap;
      }

      #cellDetails {
        position: absolute;
        border: black solid 2px;
        padding: 8px;
        background-color: #f0e5a6;
        white-space: nowrap;
      }

      #progress {
        margin-left: 3em;
        margin-right: 3em;
        border: black 3px solid;
      }

      #progressbar {
        background-color: #0000ff;
        height: 1.2em;
        width: 0;
        text-align: center;
      }

      #offline_prompt {
        background-color: #ff9999;
        border: red 4px solid;
        text-align: center;
        font-weight: bold;
      }

      #contents th, #contents td {
      }

      .busid_range_begin {
      }

      .busid_odd_range_element {
        background-color: #f0f080;
      }

      .busid_even_range_element {
        background-color: #c8f9f9;
      }

      .busid_range_end {
      }
    </style>
    <script>var COLOR=[106,90,205],PALETTE=[[230,25,75],[60,180,75],[255,225,25],[0,130,200],[245,130,48],[145,30,180],[70,240,240],[240,50,230],[210,245,60],[250,190,190],[0,128,128],[170,110,40],[128,0,0],[170,255,195],[128,128,0],[0,0,128],[128,128,128]],lineData={},lineNameMap={},lineSourceMap={},activeLines=[];function loadData(){function a(a,b,d){var e=c[a].total;if(c[a].total=d,c[a].loaded=b,e!=d){var f=1,g=0;for(var h in c)0==c[h].total?f-=c[h].weight:g+=c[h].total;for(var h in c)0!=c[h].total&&(c[h].weight=f*c[h].total/g)}var i=0;for(var h in c)0!=c[h].total&&(i+=c[h].loaded/c[h].total*c[h].weight);1<i&&(i=1),document.getElementById('progressbar').style.width=100*i+'%',document.getElementById('progressbar').innerText='Loading...'+Math.round(100*i)+'%'}var b={};manifest.sources.forEach(function(a){lineNameMap[a]={},manifest.lines[a]&&manifest.lines[a].forEach(function(c){if('__+BEGIN_LINES+__'!=c&&'__+END_LINES+__'!=c&&b[c]){var d;for(d=2;b[c+'_'+d];++d);b[c+'_'+d]=!0,lineNameMap[a][c]=c+'_'+d}else b[c]=!0})});var c={};if(manifest.sources.forEach(function(a){c[a]={total:0,loaded:0,weight:1/manifest.sources.length}}),manifest.size_hints){var d=0;for(var e in manifest.size_hints)manifest.size_hints[e]?d+=manifest.size_hints[e]:remainingProgress-=1/manifest.sources.length;for(var e in manifest.size_hints)manifest.size_hints[e]&&(c[e].weight=1*manifest.size_hints[e]/d)}Promise.all(manifest.sources.map(function(b){return new Promise(function(c){var d=manifest.data[b],e=new XMLHttpRequest;e.open('GET',d,!0),e.onreadystatechange=function(){if(4==e.readyState&&200==e.status){var d=e.responseText;-1!=d.indexOf('__BUS_LINE_DATA')&&(d=d.replace(/var __BUS_LINE_DATA=JSON\.parse\('|\\\n|'\)$/g,''));var f=JSON.parse(d);for(var g in f){var h=g;lineNameMap[b]&&lineNameMap[b][g]&&(h=lineNameMap[b][g]);var j=f[g];if(lineData[h]){console.warn('New line name conflict!');var k;for(k=2;lineData[h+'_'+k];++k);lineData[h+'_'+k]=j}else lineData[h]=j}a(b,1,1),c()}else 4==e.readyState&&c()},e.onprogress=function(c){c.lengthComputable&&a(b,c.loaded,c.total)},e.send()})})).then(function(){document.getElementById('progress').style.display='none',initializeLineChooser(),loadRemoteManifest()})}function loadRemoteManifest(){fetch('manifest.json',{cache:'no-cache'}).then((a)=>a.json()).then((a)=>{document.getElementById('last_update_container').style.display='',document.getElementById('last_update_time').appendChild(document.createTextNode(a.last_update_time))}).catch(()=>{document.getElementById('offline_prompt').style.display=''})}function isBusIdContinuous(c,a){if(c.substr(0,2)!=a.substr(0,2))return!1;var b=parseInt(c.substr(2)),d=parseInt(a.substr(2));if(b==d+1||d==b+1)return!0;return!('5-'!=c.substr(0,2)||(3!=b%10||b+2!=d)&&(3!=d%10||d+2!=b))}function initializeLineChooser(){var a=document.getElementById('lineChooser');Object.keys(lineData).sort(function(c,a){var b,d=parseInt(c),e=parseInt(a);return b=c<a?-1:c>a?1:0,isNaN(d)&&isNaN(e)?b:isNaN(d)&&!isNaN(e)?1:!isNaN(d)&&isNaN(e)?-1:d<e?-1:d>e?1:b}).forEach(function(b){var c=document.createElement('option');c.value=b,c.appendChild(document.createTextNode(b)),a.appendChild(c)}),parseUrlHash()||showLine(a.children[0].value)}function fillTr(a,b,c){var d=document.createElement('tr');return Array.prototype.forEach.call(a,function(a,e){var f=document.createElement(b?'th':'td');if(c&&c[e])for(var g in c[e])f.setAttribute(g,c[e][g]);f.appendChild(document.createTextNode(a)),d.appendChild(f)}),d}function removeChildren(a){for(;a.hasChildNodes();)a.removeChild(a.childNodes[0])}function createTableHeader(a){var b=document.createElement('thead'),c=document.createElement('tr'),d=document.createElement('th');d.appendChild(document.createTextNode('Bus ID')),c.appendChild(d);for(var e,f=null,g=!1,h=!1,j='',k=0;k<a.length;++k)e=document.createElement('th'),e.appendChild(document.createTextNode(a[k].busId)),c.appendChild(e),j=h?'busid_odd_range_element':'busid_even_range_element',0<k&&isBusIdContinuous(a[k-1].busId,a[k].busId)?g?f.className=j:(f.className='busid_range_begin '+j,g=!0):g&&(g=!1,f.className='busid_range_end '+j,h=!h),f=e;return g&&(f.className='busid_range_end '+j),b.appendChild(c),b.appendChild(fillTr(['License ID'].concat(a.map((a)=>a.licenseId)),!0)),b}function showLine(a){activeLines=[a];var b=document.getElementById('content');if(removeChildren(b),!lineData[a])return void b.appendChild(document.createTextNode('Line '+a+' does not exist!'));var c=document.createElement('table');c.appendChild(createTableHeader(lineData[a].buses));var d=document.createElement('tbody');lineData[a].details.forEach(function(a){d.appendChild(fillTr([a[0]].concat(Array(a[1].length).fill('')),!1,[''].concat(a[1].map(function(a){return{style:'background-color:rgb('+COLOR.map(function(b){return parseInt((255-b)*(1-a)+b)}).join(',')+')'}}))))}),c.appendChild(d),b.appendChild(c)}function busCompareFunction(a){return 6==a.length?function(b){return b.busId[0]==a[0]&&b.busId.substr(2)==a.substr(2)}:function(b){return b.licenseId==a.substr(Math.max(a.length-5,0))}}function findBusById(a){var b=document.getElementById('resultList');for(var c in removeChildren(b),lineData)if(lineData[c].buses.some(busCompareFunction(a))){var d=document.createElement('option');d.value=c,d.appendChild(document.createTextNode(c)),b.appendChild(d)}}function showLines(a){var b=document.getElementById('content'),c=document.getElementById('legend');if(removeChildren(b),removeChildren(c),a.length>PALETTE.length)return void b.appendChild(document.createTextNode('Too many lines selected!'));if(a.some(function(a){return!lineData[a]}))return void b.appendChild(document.createTextNode('Not all lines exist!'));for(var d=0;d<a.length;++d){var e=document.createElement('span'),f=document.createElement('span');f.style.backgroundColor='rgb('+PALETTE[d].join(',')+')',f.style.height='1em',f.style.width='2em',f.style.display='inline-block',e.style.marginLeft='3em',e.appendChild(f),e.appendChild(document.createTextNode(' '+a[d])),c.appendChild(e)}for(var g=[],h=new Set,i={},d=0;d<a.length;++d)currentLineData=lineData[a[d]],currentLineData.buses.forEach(function(a){h.has(a.licenseId)||(g.push(a),h.add(a.licenseId))}),currentLineData.details.forEach(function(b){i[b[0]]||(i[b[0]]={});for(var c,e=0;e<currentLineData.buses.length;++e)c=currentLineData.buses[e].licenseId,i[b[0]][c]||(i[b[0]][c]=Array(a.length).fill(0)),i[b[0]][c][d]=b[1][e]});g.sort(function(c,a){return c.busId&&a.busId?c.busId<a.busId?-1:c.busId>a.busId?1:0:c.busId&&!a.busId?-1:!c.busId&&a.busId?1:c.licenseId<a.licenseId?-1:c.licenseId>a.licenseId?1:0});var j=document.createElement('table');j.appendChild(createTableHeader(g));var k=document.createElement('tbody');Object.keys(i).sort().forEach(function(b){var c=document.createElement('tr'),d=document.createElement('th');d.appendChild(document.createTextNode(b)),c.appendChild(d),g.forEach(function(d){var e=document.createElement('td');c.appendChild(e);var f=0;i[b][d.licenseId]&&(f=i[b][d.licenseId].filter(function(a){return 0<a}).length),0==f||i[b][d.licenseId].forEach(function(b,c){if(0<b){var d=document.createElement('span');d.style.height='100%',d.style.width='calc(100%/'+f+')',d.style.display='inline-block',d.style.backgroundColor='rgb('+PALETTE[c].map(function(a){return parseInt((255-a)*(1-b)+a)}).join(',')+')',d.appendChild(document.createTextNode('\xA0')),d.setAttribute('data-line',a[c]),e.appendChild(d)}})}),k.appendChild(c)}),j.appendChild(k),b.appendChild(j)}function onChooseLine(){if(document.getElementById('compare').checked){if(activeLines.includes(this.value))return;activeLines.push(this.value),history.pushState(activeLines,'','#'+activeLines.join('+')),showLines(activeLines)}else{var a=this.value;showLine(a),history.pushState(a,'','#'+a)}}function loadDataFromFile(a,b){var c=document.createElement('script');c.type='text/javascript',c.src=a,document.head.appendChild(c),c.onload=function(){b(__BUS_LINE_DATA,a)}}function parseUrlHash(){if(location.hash.replace('#','')){var a=location.hash.replace('#','');return a.includes('+')?(activeLines=a.split('+'),showLines(a.split('+'))):showLine(lineChooser.value=a),!0}}document.addEventListener('DOMContentLoaded',function(){function a(a,b,c){var d=document.getElementById('cellDetails');if('none'!=d.style.display){var e=document.getElementById('cellLineContainer'),f=a;'span'==f.tagName.toLowerCase()?(f=f.parentElement,e.style.display='',document.getElementById('cellLine').innerText=a.getAttribute('data-line')):e.style.display='none',document.getElementById('cellDate').innerText=f.parentElement.children[0].innerText;var g=document.getElementById('content').querySelector('table thead');document.getElementById('cellBusId').innerText=g.children[0].children[f.cellIndex].innerText,document.getElementById('cellLicenseId').innerText=g.children[1].children[f.cellIndex].innerText,d.style.left=b+document.body.scrollLeft+document.documentElement.scrollLeft+8+'px',d.style.top=c+document.body.scrollTop+document.documentElement.scrollTop+8+'px'}}function b(){var a=document.getElementById('cellDetails');a.style.display='none'!=a.style.display||document.getElementById('disableInfotip').checked?'none':''}var c=Math.max;loadData(),lineChooser.addEventListener('change',onChooseLine),document.getElementById('resultList').addEventListener('change',onChooseLine),window.onpopstate=function(a){a.state instanceof Array?(activeLines=a.state,showLines(activeLines)):a.state?showLine(a.state):parseUrlHash()},document.getElementById('busid').addEventListener('input',function(){findBusById(this.value)}),document.getElementById('findRecent').addEventListener('click',function(){var a=parseInt(document.getElementById('findRecentDays').value)||15,b=document.getElementById('busid').value,d={};[].map.call(document.getElementById('resultList').children,function(a){return a.value}).forEach(function(e){for(var f=lineData[e].details,g=lineData[e].buses.findIndex(busCompareFunction(b)),h=c(f.length-a,0);h<f.length;++h){var i=f[h][0],j=f[h][1][g];if(j){var k={line:e,weight:j};d[i]?d[i].push(k):d[i]=[k]}}});var e=Object.keys(d).sort();e=e.slice(c(e.length-a,0)),alert(e.map(function(a){return a+': '+d[a].map(function(a){return a.line+' ('+a.weight+')'}).join(', ')}).join('\n'))}),['click','mousedown','mouseup','touchstart','touchend'].forEach(function(a){document.getElementById('findRecentDays').addEventListener(a,function(a){a.stopPropagation()})}),document.getElementById('content').addEventListener('click',function(c){var d=c.target?c.target.tagName.toLowerCase():'';('span'==d||'td'==d)&&(b(),a(c.target,c.clientX,c.clientY))});var d=!1,f=null;document.getElementById('content').addEventListener('touchstart',function(c){var e=c.target?c.target.tagName.toLowerCase():'';'span'!=e&&'td'!=e||1!=c.touches.length||d||(d=!0,f=window.setTimeout(function(){d&&(b(),a(c.target,c.touches[0].clientX,c.touches[0].clientY),d=!1,f=null)},1500))}),document.getElementById('content').addEventListener('touchmove',function(){d&&(d=!1,window.clearTimeout(f),timeout=null)}),document.getElementById('content').addEventListener('touchend',function(b){var c=b.target?b.target.tagName.toLowerCase():'';('span'==c||'td'==c&&1==b.touches.length&&d)&&(b.preventDefault(),a(b.target,b.touches[0].clientX,b.touches[0].clientY),d=!1,window.clearTimeout(f),timeout=null)}),document.getElementById('content').addEventListener('mouseover',function(b){var c=b.target?b.target.tagName.toLowerCase():'';('span'==c||'td'==c)&&a(b.target,b.clientX,b.clientY)}),document.getElementById('startDate').value='2018-01-01';var e=new Date;e.setMinutes(e.getMinutes()-e.getTimezoneOffset()),document.getElementById('endDate').value=e.toISOString().substr(0,10)});

//# sourceMappingURL=buses.min.js.map</script>
  </head>
  <body>
    <p>
      Choose line:
      <select id="lineChooser"></select>
      <label><input type="checkbox" id="compare">+ Compare</label>
      <span style="margin-left: 0.6em">
        <input type="date" id="startDate">
        ~
        <input type="date" id="endDate">
      </span>
      <span style="margin-left: 1.2em">
        Find bus:
        <input type="text" id="busid" size="5">
        <select id="resultList"></select>
        <button id="findRecent">
          Find recent
          <input type="text" id="findRecentDays" value="15" size="2">
          days
        </button>
      </span>
      <label><input type="checkbox" id="disableInfotip">Disable infotip</label>
      <span style="margin-left: 1.2em;display:none" id="last_update_container">
        Last update: <span id="last_update_time"></span>
      </span>
    </p>
    <div id="progress">
      <div id="progressbar">Loading...</div>
    </div>
    <div id="offline_prompt" style="display:none">
      You're offline now. Data shown below may not be up-to-date.
    </div>
    <div id="legend"></div>
    <div id="content"></div>
    <div id="cellDetails" style="display:none">
      Date: <span id="cellDate"></span><br>
      <span id="cellLineContainer" style="display:none">
        Line: <span id="cellLine"></span><br>
      </span>
      Bus ID: <span id="cellBusId"></span><br>
      License ID: <span id="cellLicenseId"></span>
    </div>
  </body>
</html>
