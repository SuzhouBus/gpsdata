<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>苏州公交</title>
    <link rel="manifest" href="manifest.webmanifest">
    <script data-feature-detection>
      var legacy = !history.pushState || !window.Promise || !window.fetch || !String.prototype.includes || !Array.prototype.includes;
      try {
        Function('class test{async t(){let e=x=>x;const s=0;await 0;}}');
      } catch(e) {
        legacy = true;
      }
      if (legacy) {
        location.replace('sz3.legacy.html');
      }
    </script>
    
    
    
    
    
    
    <script>
      var manifest = (
// BEGIN MANIFEST
{
  "sources": ["sz3", "sz4", "wj"],
  "last_update_time": "2018-06-21 14:30:01",
  "data": {
    "sz3": "sz3.json",
    "sz4": "sz4.json",
    "wj": "wj.json"
  },
  "size_hints": {
    "sz3": 183,
    "sz4": 142,
    "wj": 59
  },
  "gzip_ratio_hint": 0.2265,
  "start_date": "2018-04-30",
  "lines": {
    "sz3": ["__+BEGIN_LINES+__","1001","100","101","102","102N","108","109","10N","10S","112","118","119","126","142","146","161","166","169","170N","170S","175","178","179","190","190N","190S","19","1","200","200N","200S","202","204","209","218","219","261","262","26","27","27D","2SIP","2SND","3002","301","304","304L","305","307","308","311","311L","312","313","315","317","318","31","321","324","325","32","32Q","331","33","34","34LN","34N","35","360","36","38","406","40E","40W","415","42","441","446","44","45","47","4","501","502","502D","511","513","514","518","521","522","523","526","529","52","53","552","553","557","558","563","56","585","5","602","60","60N","60S","621","622","62","64","65","663","66","67","698","69","69Q","7","810","810E","810W","811","812","813","814","815","816","817","818","819","81","827","82","84","85","865","866","86","871","872","873","875","876","877","878","879","87","89","8","9001","9002","9003","9004","9005","9006","9007","9008","9009","900","900N","900S","9011","902","921","922","923","925","926","928","931","932","933","935","937","949","970","970E","970W","980","980E","980W","9","G10","G11","G12","G2N","G2S","G8","G14","J3","K1","K6","K7","N1","N2","N3","N5","XT","Y1","Y1N","Y1S","Y2","Y3","Y4","Y4L","Y5","Y5N","Y5S","__+END_LINES+__"],
    "sz4": ["__+BEGIN_LINES+__","1001E","1001W","100N","100S","106","106Q","110N","110S","111","116","120E","120W","127","129","132","136","141","150N","150S","152","156","158","162","16","175","176","180N","180S","182","185","206","207","215","238","28","2SIP","2SND","3002","300N","300S","302","303","306","309","316","319","322","326","328","329","332","333","335","336","336Q","338","356","357","360","37","39","3","400E","400W","43","442","443","445","5005","503","504","505","508","509","512","518","51","528","54","557","55","560","58","59","611","612","615","623","627","628","63","691","692","6","801","802","803","804","805","805Q","806","807","808","809","80","80N","80S","810E","810W","811","812","813","814","815","816","817","818","819","81","820","820E","820W","821","822","823","824","825","826","828","82","831","832","833","835","836","837","839","83","84","851","852","853","854","855","856","85","85D","861","862","863","864","865","866","86","871","872","873","875","876","877","878","879","87","881","882","883","88","89","923","9001","9002","9002E","9002W","9003","9004","9005","9005E","9005W","9006","9007","9008","9009","9010","9011","9012","9013","9026","922","925","928","9","931","G6","G7","G14","JLJ","K3","K5","K8","K8Z","N10","N4","N6","N7","N8","N9","SP","SZL","__+END_LINES+__"]
  },
  "line_name_map": {
    "LL": "黎里专线",
    "LH": "临沪专线",
    "SZ": "盛泽专线",
    "TY": "桃源专线",
    "BD": "八都专线",
    "ZZ": "震泽专线",
    "QD": "七都专线",
    "SP": "胜浦专线",
    "JLJ": "津梁街专线",
    "XT": "斜塘专线",
    "SZL": "宋庄路专线",
    "180S": "180E",
    "180N": "180W",
    "10S": "10E",
    "10N": "10W"
  },
  "line_name_prefix_map": {
    "Y": "游 ",
    "K": ["快线 ", " 号"],
    "J": "假日专线 ",
    "N": "夜 ",
    "G": ["高峰 ", " 号"]
  },
  "line_name_suffix_map": {
    "N": "北线",
    "S": "南线",
    "E": "东线",
    "W": "西线",
    "Q": "区间",
    "Z": "支线",
    "L": "长线",
    "D": "大站车",
    "G": "高峰",
    "LN": "长线北",
    "SIP": "园区",
    "SND": "市公交"
  },
  "archives": {
    "sz3": {
      "path": "archive/sz3/",
      "start_date": "2016-11-23",
      "end_date": "2018-05-31",
      "lengths": {
        "2016-11": 145591,
        "2016-12": 455012,
        "2017-01": 299516,
        "2017-02": 183998,
        "2017-03": 474636,
        "2017-04": 252009,
        "2017-05": 413524,
        "2017-06": 564033,
        "2017-07": 581499,
        "2017-08": 601732,
        "2017-09": 586103,
        "2017-10": 601508,
        "2017-11": 591923,
        "2017-12": 685229,
        "2018-01": 647435,
        "2018-02": 598271,
        "2018-03": 650013,
        "2018-04": 705964
      }
    },
    "sz4": {
      "path": "archive/sz4/",
      "start_date": "2017-04-15",
      "end_date": "2018-05-31",
      "lengths": {
        "2017-04": 94727,
        "2017-05": 164103,
        "2017-06": 155364,
        "2017-07": 191409,
        "2017-08": 377723,
        "2017-09": 469502,
        "2017-10": 482273,
        "2017-11": 495497,
        "2017-12": 516358,
        "2018-01": 532198,
        "2018-02": 476503,
        "2018-03": 544753,
        "2018-04": 569378
      }
    },
    "wj": {
      "path": "archive/wj/",
      "start_date": "2018-03-15",
      "end_date": "2018-05-31",
      "lengths": {
        "2018-03": 140006,
        "2018-04": 244506
      }
    }
  }
}
// END MANIFEST
      );
    </script>
    <style>
      body {
        font-size: 12pt;
      }

      #cellDetails {
        position: absolute;
        border: black solid 2px;
        padding: 8px;
        background-color: #f0e5a6;
        white-space: nowrap;
      }

      #progress {
        margin-left: 3em;
        margin-right: 3em;
        border: black 3px solid;
      }

      #progressbar {
        background-color: #0000ff;
        height: 1.2em;
        width: 0;
      }
      
      #progress_text {
        position: absolute;
        left: 0;
        right: 0;
        text-align: center;
        white-space: nowrap;
      }

      #offline_prompt {
        background-color: #ff9999;
        border: red 4px solid;
        text-align: center;
        font-weight: bold;
      }

      #content table {
        border-spacing: 0;
      }

      #content th {
        white-space: nowrap;
        margin-left: 0.3ex;
        margin-right: 0.3ex;
      }

      .busid_range_begin {
      }

      .busid_odd_range_element {
        background-color: #f0f080;
      }

      .busid_even_range_element {
        background-color: #c8f9f9;
      }

      .busid_range_end {
      }

      .line_view_bus_item {
        height: 100%;
        display: inline-block;
        text-align: center;
      }

      .line_legend_item {
        height: 1em;
        width: 2em;
        display: inline-block;
        margin-left: 2.5em;
      }
    </style>
    <script>function _asyncToGenerator(a){return function(){var b=a.apply(this,arguments);return new Promise(function(a,c){function d(e,f){try{var g=b[e](f),h=g.value}catch(a){return void c(a)}return g.done?void a(h):Promise.resolve(h).then(function(a){d('next',a)},function(a){d('throw',a)})}return d('next')})}}class DateUtils{static formatNumber_(a){let b=a.toString();return 1==b.length?'0'+b:b}static formatDate(a,b,c){let d=a.toString();return b&&(d+='-'+DateUtils.formatNumber_(b)),c&&(d+='-'+DateUtils.formatNumber_(c)),d}static toYearMonth(a){let b=a.indexOf('-');if(-1==b)return a;let c=a.indexOf('-',b+1);return-1==c?a:a.substr(0,c)}static nextMonth(a){let b=a.split('-').map((a)=>parseInt(a));return b[1]++,12<b[1]&&(b[0]+=Math.floor(b[1]/12),b[1]%=12),b[2]&&b[2]>DateUtils.daysInMonthsMap_[b[1]]&&(b[2]=DateUtils.daysInMonthsMap_[b[1]]),DateUtils.formatDate.apply(null,b)}static previousMonth(a){let b=a;return'string'==typeof a&&(b=a.split('-').map((a)=>parseInt(a))),b[1]--,0==b[1]&&(b[0]--,b[1]=12),b[2]&&b[2]>DateUtils.daysInMonthsMap_[b[1]]&&(b[2]=DateUtils.daysInMonth(b[1])),DateUtils.formatDate.apply(null,b)}static yesterday(a){let b=a.split('-').map((a)=>parseInt(a));if(b[2]--,0==b[2]){let a=DateUtils.previousMonth(b.slice(0,2)),c=a.split('-').map((a)=>parseInt(a));return a+'-'+DateUtils.formatNumber_(DateUtils.daysInMonth(c[0],c[1]))}return DateUtils.formatDate.apply(null,b)}static isLeapYear(a){return a=parseInt(a),0==a%400||0!=a%100&&0==a%4}static daysInMonth(a,b){return b=parseInt(b),2==b&&DateUtils.isLeapYear(a)?29:DateUtils.daysInMonthsMap_[b]}}DateUtils.daysInMonthsMap_=[void 0,31,28,31,30,31,30,31,31,30,31,30,31];class LineDataManager{constructor(a){this.manifest=a,this.loadedLineData_={},this.lineData_={};let b=new Date;b.setMinutes(b.getMinutes()-b.getTimezoneOffset()),this.today_=b.toISOString().substr(0,10),this.earliestDate=Object.keys(a.archives||{}).map((b)=>a.archives[b].start_date).concat([a.start_date]).reduce((a,b)=>b<a?b:a,'9999-99-99'),this.initializeLineNameMap_(a)}initializeLineNameMap_(a){this.lineNameMap_={};let b={};a.sources.forEach((c)=>{this.lineNameMap_[c]={},a.lines[c]&&a.lines[c].forEach((a)=>{if('__+BEGIN_LINES+__'!=a&&'__+END_LINES+__'!=a&&b[a]){let d;for(d=2;b[a+'_'+d];++d);b[a+'_'+d]=!0,this.lineNameMap_[c][a]=a+'_'+d}else b[a]=!0})})}appendLineDataToLoad_(a,b,c){return'string'==typeof c?c=[c]:void 0==c&&(c=this.manifest.sources),Array.prototype.push.apply(a,c.filter((a)=>!this.loadedLineData_[b]||!this.loadedLineData_[b][a]).map((a)=>'current'==b?{month:b,source:a,sizeHint:this.manifest.size_hints[a]}:this.manifest.archives[a]&&this.manifest.archives[a].lengths?{month:b,source:a,lengthTotal:this.manifest.archives[a].lengths[b],lengthAccurate:!0}:{month:b,source:a})),a}isRangeOverlapped_(a,b,c,d){return a<=d&&b>=c}getDataToLoad_(a,b){let c=[];if(this.isRangeOverlapped_(a,b,this.manifest.start_date,this.today_)&&this.appendLineDataToLoad_(c,'current'),a<this.manifest.start_date&&(a<this.earliestDate&&(a=this.earliestDate),b>=this.manifest.start_date&&(b=DateUtils.yesterday(this.manifest.start_date)),a<=b)){let d=DateUtils.toYearMonth(a),e=DateUtils.toYearMonth(b),f=Object.keys(this.manifest.archives||{}).map((a)=>{let b=Object.assign({},this.manifest.archives[a],{name:a});return b.start_month=DateUtils.toYearMonth(b.start_date),b.end_month=DateUtils.toYearMonth(b.end_date),b}).filter((c)=>this.isRangeOverlapped_(a,b,c.start_date,c.end_date));for(let d=DateUtils.toYearMonth(a);d<=DateUtils.toYearMonth(b);d=DateUtils.nextMonth(d))this.appendLineDataToLoad_(c,d,f.filter((a)=>d>=a.start_month&&d<=a.end_month).map((a)=>a.name))}return c}load(a,b){var c=this;return _asyncToGenerator(function*(){let d=c.getDataToLoad_(a,b);for(let a of d){let b,e=a.lengthTotal||0,f=!0,g=a.month.replace('-','')+'.json';b='current'==a.month?c.manifest.data[a.source]:c.manifest.archives[a.source].path+g,yield fetch(b).then((()=>{var b=_asyncToGenerator(function*(b){if(window.TextDecoder&&b.body&&b.body.getReader){if(!e){let a=b.headers.get('Content-Encoding'),d=b.headers.get('Content-Length');(!a||'identity'==a)&&d?e=d:'gzip'==a&&d&&(e=d/(c.manifest.gzip_ratio_hint||.5),f=!1)}if(e){a.lengthTotal=e,a.lengthAccurate=f,a.lengthLoaded=0;let g=b.body.getReader(),h=!1,i=new TextDecoder,j='';for(;!h;)yield g.read().then(function(b){b.done&&(h=!0),b.value&&(j+=i.decode(b.value,{stream:b.done}),a.lengthLoaded+=b.value.length,c.onUpdateProgress&&c.onUpdateProgress(d,a))});return JSON.parse(j)}}return b.json()});return function(){return b.apply(this,arguments)}})()).then(function(b){c.loadedLineData_[a.month]||(c.loadedLineData_[a.month]={}),c.loadedLineData_[a.month][a.source]=b,c.importData_(a.month,a.source),a.loaded=!0,c.onUpdateProgress&&c.onUpdateProgress(d,a)}).catch(function(){return a.loaded=!1},Promise.resolve())}return d})()}importData_(a,b){let c=this.loadedLineData_[a][b];Object.keys(c).forEach((d)=>{let e=this.lineNameMap_[b][d]||d;this.lineData_[e]||(this.lineData_[e]={}),this.lineData_[e][a]=c[d]})}isDataLoaded(a,b){return 0==this.getDataToLoad_(a,b).length}getMonthsByRange_(a,b){return Object.keys(this.loadedLineData_).filter((c)=>'current'==c?this.isRangeOverlapped_(a,b,this.manifest.start_date,this.today_):DateUtils.toYearMonth(a)<=c&&DateUtils.toYearMonth(b)>=c)}queryLines(a,b,c){'string'==typeof a&&(a=[a]);let d={},e={};a.forEach((f,g)=>{this.getMonthsByRange_(b,c).sort().forEach((h)=>{let j=this.lineData_[f][h];j&&(j.buses.forEach((a)=>{d[a.licenseId]?d[a.licenseId].busId!=a.busId&&(d[a.licenseId].busId=a.busId):d[a.licenseId]=Object.assign({},a)}),j.details.filter((a)=>a[0]>=b&&a[0]<=c).forEach((b)=>{e[b[0]]||(e[b[0]]={});for(let c,f=0;f<j.buses.length;++f){c=j.buses[f].licenseId,e[b[0]][c]||(e[b[0]][c]=Array(a.length).fill(0));let h=b[1][f];e[b[0]][c][g]=h,0<h&&(d[c].hasWeight=!0)}}))})});let f=this.sortBuses_(Object.keys(d).filter((a)=>d[a].hasWeight).map((a)=>d[a])),g=Array(a.length).fill(0),h=Object.keys(e).sort().map((a)=>[a,f.map((b)=>e[a][b.licenseId]||g)]);return{buses:f,details:h}}containsLines(a){return'string'==typeof a&&(a=[a]),!a.some((a)=>!this.lineData_[a])}queryBuses(a,b,c,d){let e=new Set,f={},g={};(a.lines||Object.keys(this.lineData_)).forEach((h)=>{this.getMonthsByRange_(b,c).sort().forEach((i)=>{let j=this.lineData_[h][i],k=null;j&&j.buses.forEach((i,l)=>{if(this.compareBus_(i,a)){f[i.licenseId]?f[i.licenseId].busId!=i.busId&&(f[i.licenseId].busId=i.busId):f[i.licenseId]=Object.assign({},i),k||(k=j.details.filter((a)=>a[0]>=b&&a[0]<=c));for(let a of k){g[a[0]]||(g[a[0]]={});let b=a[1][l];if(0<b&&(g[a[0]][i.licenseId]||(g[a[0]][i.licenseId]={}),g[a[0]][i.licenseId][h]=b,e.add(h),!d))break}}})})});let h=this.sortLines_(Array.from(e));if(!d)return{lines:h};let i=this.sortBuses_(Object.keys(f).map((a)=>f[a])),j=Object.keys(g).sort().map((a)=>[a,i.map((b)=>h.map((c)=>(g[a][b.licenseId]||{})[c]||0))]);return{lines:h,buses:i,details:j}}compareBus_(a,b){let c=!1;return['busId','licenseId'].forEach((d)=>{b[d]&&(c|=b[d].some((b)=>'string'==typeof b?a[d]==b:b.start&&b.end?a[d]>=b.start&&a[d]<=b.end:b.prefix?a[d].substr(0,b.prefix.length)==b.prefix:b.suffix?a[d].substr(-b.suffix.length)==b.suffix:void 0))}),c}getLines(){return this.sortLines_(Object.keys(this.lineData_))}sortLines_(a){let c='plain'==this.linesSortOrder;return a.sort((d,a)=>{let b,e=parseInt(d),f=parseInt(a);return b=d<a?-1:d>a?1:0,c?b:isNaN(e)&&isNaN(f)?b:isNaN(e)&&!isNaN(f)?1:!isNaN(e)&&isNaN(f)?-1:e<f?-1:e>f?1:b})}sortBuses_(a){return a.sort((c,a)=>{if(c.busId&&a.busId)return c.busId<a.busId?-1:c.busId>a.busId?1:0;return c.busId&&!a.busId?-1:!c.busId&&a.busId?1:c.licenseId<a.licenseId?-1:c.licenseId>a.licenseId?1:0})}isDateRangeValid(a,b){return a>=this.earliestDate&&b<=this.today_}}const COLOR=[106,90,205],COLOR_GREY=[160,160,160],PALETTE=[[230,25,75],[60,180,75],[255,225,25],[0,130,200],[245,130,48],[145,30,180],[70,240,240],[240,50,230],[210,245,60],[250,190,190],[0,128,128],[170,110,40],[128,0,0],[170,255,195],[128,128,0],[0,0,128]];let currentStartDate,currentEndDate,lineDataManager=new LineDataManager(manifest),progressText='',activeLines=[];(function(){var a=new Date;a.setMinutes(a.getMinutes()-a.getTimezoneOffset()),currentEndDate=a.toISOString().substr(0,10);a.getMonth();a.setDate(a.getDate()-30+1),currentStartDate=a.toISOString().substr(0,10)})();function loadRemoteManifest(){fetch('manifest.json',{cache:'no-cache'}).then((a)=>a.json()).then((a)=>{document.getElementById('last_update_container').style.display='',document.getElementById('last_update_time').appendChild(document.createTextNode(a.last_update_time))}).catch(()=>{document.getElementById('offline_prompt').style.display=''})}function isBusIdContinuous(c,a){if(c.substr(0,2)!=a.substr(0,2))return!1;var b=parseInt(c.substr(2)),d=parseInt(a.substr(2));if(b==d+1||d==b+1)return!0;return!('5-'!=c.substr(0,2)||(3!=b%10||b+2!=d)&&(3!=d%10||d+2!=b))}function convertLineName(a,b){if(b.line_name_map&&b.line_name_map[a])return convertLineName(b.line_name_map[a],b);let c=/^([^0-9]*)([0-9]+)([^0-9_]*)(.*)$/.exec(a);if(c){if(c[1]&&b.line_name_prefix_map&&b.line_name_prefix_map[c[1]]){let a=b.line_name_prefix_map[c[1]];'string'==typeof a?c[1]=a:(c[1]=a[0],c[2]+=a[1])}return c[3]&&b.line_name_suffix_map&&b.line_name_suffix_map[c[3]]&&(c[3]='\uFF08'+b.line_name_suffix_map[c[3]]+'\uFF09'),c[1]+c[2]+c[3]+c[4]}return a}function updateLineChooser(a){var b=document.getElementById('lineChooser');a.forEach((a)=>{let c=document.createElement('option');c.value=a,c.appendChild(document.createTextNode(convertLineName(a,manifest))),b.appendChild(c)})}function fillTr(a,b,c){var d=document.createElement('tr');return Array.prototype.forEach.call(a,function(a,e){var f=document.createElement(b?'th':'td');if(c&&c[e])for(var g in c[e])f.setAttribute(g,c[e][g]);f.appendChild(document.createTextNode(a)),d.appendChild(f)}),d}function removeChildren(a){for(;a.hasChildNodes();)a.removeChild(a.childNodes[0])}function createTableHeader(a){var b=document.createElement('thead'),c=document.createElement('tr'),d=document.createElement('th');d.appendChild(document.createTextNode('\u81EA\u7F16\u53F7')),c.appendChild(d);for(var e,f=null,g=!1,h=!1,j='',k=0;k<a.length;++k)e=document.createElement('th'),e.appendChild(document.createTextNode(a[k].busId)),c.appendChild(e),j=h?'busid_odd_range_element':'busid_even_range_element',0<k&&isBusIdContinuous(a[k-1].busId,a[k].busId)?g?f.className=j:(f.className='busid_range_begin '+j,g=!0):g&&(g=!1,f.className='busid_range_end '+j,h=!h),f=e;return g&&(f.className='busid_range_end '+j),b.appendChild(c),b.appendChild(fillTr(['\u8F66\u724C\u53F7'].concat(a.map((a)=>a.licenseId)),!0)),b}function convertBusQuery(a){const b=/^([0-9])(?:0|-)([0-9]{4})$/,c=/^([0-9])(?:0|-)([0-9]{4})(?:~|～)([0-9])(?:0|-)([0-9]{4})$/,d=/^(?:苏s*E[^0-9A-Z]{0,4})?([0-9A-Z]{5}|[0-9]{5}(?:D|F))$/i,e=/^(?:苏s*E[^0-9A-Z]{0,4})?([0-9A-Z]{5}|[0-9]{5}(?:D|F))(?:~|～)(?:苏s*E[^0-9A-Z]{0,4})?([0-9A-Z]{5}|[0-9]{5}(?:D|F))$/i,f=/^([^~～*?#]+)(?:\*|\?|#){1,3}$/;let g={busId:[],licenseId:[]},h=a.split(/,|;|，|；|、|\s+/);return h.forEach((a)=>{let h=null;(h=c.exec(a))?g.busId.push({start:h[1]+'-'+h[2],end:h[3]+'-'+h[4]}):(h=e.exec(a))?g.licenseId.push({start:h[1].toUpperCase(),end:h[2].toUpperCase()}):(h=f.exec(a))?h[1].includes('-')?g.busId.push({prefix:h[1]}):g.licenseId.push({prefix:h[1].toUpperCase()}):(h=b.exec(a))?g.busId.push(h[1]+'-'+h[2]):(h=d.exec(a))?g.licenseId.push(h[1].toUpperCase()):'*'==a[0]&&g.licenseId.push({suffix:a.substr(1)})}),g}function findBusByQuery(a){let b=document.getElementById('resultList'),c=document.getElementById('bus_count_container'),d=document.getElementById('bus_count');removeChildren(b);let e=lineDataManager.queryBuses(convertBusQuery(a),currentStartDate,currentEndDate,!0);0<e.lines.length?(e.lines.forEach((a)=>{let c=document.createElement('option');c.value=a,c.appendChild(document.createTextNode(a)),b.appendChild(c)}),d.innerText=e.buses.length,c.style.display=''):c.style.display='none'}function showLinesNew(a,b,c){'string'==typeof a&&(a=[a]);let d=document.getElementById('content'),e=document.getElementById('legend');if(removeChildren(d),removeChildren(e),a.length>PALETTE.length&&!c)return void d.appendChild(document.createTextNode('\u60A8\u9009\u62E9\u7684\u7EBF\u8DEF\u592A\u591A\u4E86\uFF01'));if(!b&&!lineDataManager.containsLines(a))return void d.appendChild(document.createTextNode('\u67D0\u4E9B\u7EBF\u8DEF\u4E0D\u5B58\u5728\uFF01'));1<a.length&&a.forEach((a,b)=>{let d=document.createElement('span'),f=document.createElement('span');f.style.backgroundColor='rgb('+PALETTE[c?b%PALETTE.length:b].join(',')+')',f.style.height='1em',f.style.width='2em',f.style.display='inline-block',d.style.marginLeft='3em',d.appendChild(f),d.appendChild(document.createTextNode(' '+a)),e.appendChild(d)});let f=b||lineDataManager.queryLines(a,currentStartDate,currentEndDate),g=document.createElement('table');g.appendChild(createTableHeader(f.buses));let h=document.createElement('tbody');f.details.forEach((b)=>{var d=document.createElement('tr'),e=document.createElement('th');e.appendChild(document.createTextNode(b[0])),d.appendChild(e),f.buses.forEach((e,f)=>{var g=document.createElement('td');d.appendChild(g);var h=0;if(h=b[1][f].filter((a)=>0<a).length,0==h){if(c){var i=document.createElement('span');i.className='line_view_bus_item',i.style.width='100%',i.style.backgroundColor='rgb('+COLOR_GREY.join(',')+')',i.appendChild(document.createTextNode('\xA0')),g.appendChild(i)}return}let j=!0;b[1][f].forEach((b,d)=>{if(0<b){var e=document.createElement('span');if(e.className='line_view_bus_item',e.style.width=100/h+'%',e.setAttribute('data-line',a[d]),c){e.style.color='rgb('+PALETTE[d%PALETTE.length],e.style.fontWeight='bold',e.style.backgroundColor='rgb('+COLOR_GREY.map((a)=>parseInt((255-a)*b+a)).join(',')+')';let c=a[d];j?j=!1:c='/'+c,e.appendChild(document.createTextNode(c))}else e.style.backgroundColor='rgb('+(1==a.length?COLOR:PALETTE[d]).map((a)=>parseInt((255-a)*(1-b)+a)).join(',')+')',e.appendChild(document.createTextNode('\xA0'));g.appendChild(e)}})}),h.appendChild(d)}),g.appendChild(h),d.appendChild(g)}function onChooseLine(){if(document.getElementById('compare').checked){if(activeLines.includes(this.value))return;activeLines.push(this.value),history.pushState(activeLines,'','#'+activeLines.join('+')),showLinesNew(activeLines)}else{var a=this.value;activeLines=[a],showLinesNew(a),history.pushState(a,'','#'+a)}}function parseUrlHash(){if(location.hash.replace('#','')){var a=location.hash.replace('#','');return a.includes('+')?(activeLines=a.split('+'),showLinesNew(activeLines)):(activeLines=[a],lineChooser.value=a,showLinesNew(a)),!0}}function onModifyDate(){let a=document.getElementById('startDate'),b=document.getElementById('endDate');if(!(lineDataManager.isDateRangeValid(a.value,b.value)&&(currentStartDate!=a.value||currentEndDate!=b.value)))a.value=currentStartDate,b.value=currentEndDate;else if(currentStartDate=a.value,currentEndDate=b.value,lineDataManager.isDataLoaded(currentStartDate,currentEndDate))showLinesNew(activeLines);else{let a=document.getElementById('progress');document.getElementById('progressbar').style.width=0,document.getElementById('progress_text').innerText=progressText,a.style.display='',lineDataManager.load(currentStartDate,currentEndDate).then(()=>{a.style.display='none',updateLineChooser(lineDataManager.getLines()),showLinesNew(activeLines)})}}function init(){function a(a,b,d){var e=document.getElementById('cellDetails');if('none'!=e.style.display){var f=document.getElementById('cellLineContainer'),g=a;'span'==g.tagName.toLowerCase()?(g=g.parentElement,f.style.display='',document.getElementById('cellLine').innerText=a.getAttribute('data-line')):f.style.display='none',document.getElementById('cellDate').innerText=g.parentElement.children[0].innerText;var h=document.getElementById('content').querySelector('table thead');document.getElementById('cellBusId').innerText=h.children[0].children[g.cellIndex].innerText,document.getElementById('cellLicenseId').innerText=h.children[1].children[g.cellIndex].innerText,e.style.left=c(b,window.innerWidth&&e.clientWidth?window.innerWidth-e.clientWidth-30:b)+document.body.scrollLeft+document.documentElement.scrollLeft+8+'px',e.style.top=c(d,window.innerHeight&&e.clientHeight?window.innerHeight-e.clientHeight-30:d)+document.body.scrollTop+document.documentElement.scrollTop+8+'px'}}function b(){var a=document.getElementById('cellDetails');a.style.display='none'!=a.style.display||document.getElementById('disableInfotip').checked?'none':''}var c=Math.min;let d=document.getElementById('lineChooser'),e=document.getElementById('startDate'),f=document.getElementById('endDate');progressText=document.getElementById('progress_text').innerText,lineDataManager.onUpdateProgress=function(a){let b=document.getElementById('progressbar'),d=a.filter((a)=>a.sizeHint),e=d.reduce((a,b)=>a+=b.sizeHint,0),f=d.reduce((a,b)=>{let d=b.sizeHint/e;return b.loaded?a+=d:b.lengthLoaded&&b.lengthTotal&&(b.lengthAccurate?a+=d*b.lengthLoaded/b.lengthTotal:a+=d*c(b.lengthLoaded,.95*b.lengthTotal)/b.lengthTotal),a},0),g=a.filter((a)=>a.lengthAccurate&&!a.sizeHint),h=g.reduce((a,b)=>a+=b.lengthTotal,0),i=g.reduce((a,b)=>{let c=b.lengthTotal/h;return b.loaded?a+=c:b.lengthLoaded&&(a+=c*b.lengthLoaded/b.lengthTotal),a},0),j=100*(f*d.length/a.length+i*g.length/a.length);b.style.width=j+'%',document.getElementById('progress_text').innerText=progressText+Math.round(j)+'%'},lineDataManager.load(currentStartDate,currentEndDate).then(()=>{document.getElementById('progress').style.display='none',updateLineChooser(lineDataManager.getLines()),parseUrlHash()||(activeLines=[d.children[0].value],showLinesNew(activeLines)),loadRemoteManifest()}),e.value=currentStartDate,f.value=currentEndDate,e.addEventListener('change',onModifyDate),f.addEventListener('change',onModifyDate),d.addEventListener('change',onChooseLine),document.getElementById('resultList').addEventListener('change',onChooseLine),window.onpopstate=function(a){a.state instanceof Array?(activeLines=a.state,showLinesNew(activeLines)):a.state?(activeLines=[a.state],showLinesNew(a.state)):parseUrlHash()},document.getElementById('bus_query').addEventListener('input',function(){findBusByQuery(this.value)}),document.getElementById('findDetails').addEventListener('click',function(){let a=lineDataManager.queryBuses(Object.assign({lines:[].map.call(document.getElementById('resultList').children,(a)=>a.value)},convertBusQuery(document.getElementById('bus_query').value)),currentStartDate,currentEndDate,!0);showLinesNew(a.lines,a,!0)}),document.getElementById('content').addEventListener('click',function(c){var d=c.target?c.target.tagName.toLowerCase():'';('span'==d||'td'==d)&&(b(),a(c.target,c.clientX,c.clientY))});var g=!1,h=null;document.getElementById('content').addEventListener('touchstart',function(c){var d=c.target?c.target.tagName.toLowerCase():'';'span'!=d&&'td'!=d||1!=c.touches.length||g||(g=!0,h=window.setTimeout(function(){g&&(b(),a(c.target,c.touches[0].clientX,c.touches[0].clientY),g=!1,h=null)},1500))}),document.getElementById('content').addEventListener('touchmove',function(){g&&(g=!1,window.clearTimeout(h),timeout=null)}),document.getElementById('content').addEventListener('touchend',function(b){var c=b.target?b.target.tagName.toLowerCase():'';('span'==c||'td'==c&&1==b.touches.length&&g)&&(b.preventDefault(),a(b.target,b.touches[0].clientX,b.touches[0].clientY),g=!1,window.clearTimeout(h),timeout=null)}),document.getElementById('content').addEventListener('mouseover',function(b){var c=b.target?b.target.tagName.toLowerCase():'';('span'==c||'td'==c)&&a(b.target,b.clientX,b.clientY)})}(function(){function a(){b||(init(),b=!0)}let b=!1;document.onload=a,document.onreadystatechange=function(){'complete'==document.readyState&&a()},document.addEventListener('DOMContentLoaded',a)})();

//# sourceMappingURL=buses.min.js.map</script>
  </head>
  <body>
    <div style="margin-bottom: 1em">
      选择线路：<select id="lineChooser"></select>
      <label><input type="checkbox" id="compare">+ 比较</label>
      <span style="margin-left: 0.6em">
        <input type="date" id="startDate">
        ~
        <input type="date" id="endDate">
      </span>
      <span style="margin-left: 1.2em">
        寻找车辆：<input type="text" id="bus_query" size="20">
        <span id="bus_count_container" style="display:none">
          （共
          <span id="bus_count"></span>
          台）
        </span>
        <select id="resultList"></select>
        <button id="findDetails">
          搜索
        </button>
      </span>
      <label><input type="checkbox" id="disableInfotip">关闭提示</label>
      <span style="margin-left: 1.2em;display:none" id="last_update_container">
        最后更新时间：<span id="last_update_time"></span>
      </span>
    </div>
    <div id="progress">
      <span id="progress_text">正在加载，请稍候……</span>
      <div id="progressbar"></div>
    </div>
    <div id="offline_prompt" style="display:none">
      您目前处于离线状态，下方的数据可能不是最新的。
    </div>
    <div id="legend"></div>
    <div id="content"></div>
    <div id="cellDetails" style="display:none">
      日期：<span id="cellDate"></span><br>
      <span id="cellLineContainer" style="display:none">
        线路：<span id="cellLine"></span><br>
      </span>
      自编号：<span id="cellBusId"></span><br>
      车牌号：<span id="cellLicenseId"></span>
    </div>
  </body>
</html>
